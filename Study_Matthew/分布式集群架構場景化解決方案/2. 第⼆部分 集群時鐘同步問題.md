---
date: 2021-12-09
aliases: []
---

# Metadata

**Title** :: MyBatis

**Author** :: #Matthew 

**Classification** :: #Learn #Java #Basic #MyBatis

**Status** :: #🌱

**Type** :: #Note

**Previous** ::[[Study_Matthew/分布式集群架構場景化解決方案/1. 第⼀部分 ⼀致性Hash算法]]

**ParentNode** :: [[Study_Matthew/分布式集群架構場景化解決方案/分布式集群架構場景化解決方案]]

---


# 第⼆部分：集群時鐘同步問題

## 第 1 節 時鐘不同步導致的問題
時鐘此處指服務器時間，如果集群中各個服務器時鐘不⼀致勢必導致⼀系列問題，試想 “集群是各個服務器⼀起團隊化作戰，⼤家⼯作都不在⼀個點上，豈不亂了套！ ”

舉⼀個例⼦，電商⽹站業務中，新增⼀條訂單，那麼勢必會在訂單表中增加了⼀條記錄，該條記錄中應該會有“下單時間”這樣的字段，往往我們會在程序中獲取當前系統時間插⼊到數據庫或者直接從數據庫服務器獲取時間。那我們的訂單⼦系統是集群化部署，或者我們的數據庫也是分庫分錶的集群化部署，**然⽽他們的系統時鐘缺不⼀致，⽐如有⼀台服務器的時間是昨天**，那麼這個時候下單時間就成了昨天，那我們的數據將會混亂！如下

![[Study_Matthew/分布式集群架構場景化解決方案/_annex/Pasted image 20211209135304.png]]

## 第 2 節 集群時鐘同步配置
- 集群時鐘同步思路
	- 分佈式集群中各個服務器節點都可以連接互聯⽹
		思路：
		
		![[Study_Matthew/分布式集群架構場景化解決方案/_annex/Pasted image 20211209135356.png]]
		
		操作⽅式：
		
		```cmd
		#使⽤ ntpdate ⽹絡時間同步命令
		ntpdate -u ntp.api.bz #從⼀個時間服務器同步時間
		```
		windows有計劃任務
		
		Linux也有定時任務，crond，可以使⽤linux的定時任務，每隔10分鐘執⾏⼀次ntpdate命令
		
	- 分佈式集群中某⼀個服務器節點可以訪問互聯⽹或者所有節點都不能夠訪問互聯⽹
		
		X思路：
		
		![[Study_Matthew/分布式集群架構場景化解決方案/_annex/Pasted image 20211209140341.png]]
		
		操作⽅式：
		
		1）選取集群中的⼀個服務器節點A(172.17.0.17)作為時間服務器（整個集群時間從這台服務器同步，如果這台服務器能夠訪問互聯⽹，可以讓這台服務器和⽹絡時間保持同步，如果不能就⼿動設置⼀個時間）
		
		- ⾸先設置好A的時間
		- 把A配置為時間服務器（修改/etc/ntp.conf⽂件）
			```cmd
			1、如果有 restrict default ignore，註釋掉它
			2、添加如下⼏⾏內容
			 restrict 172.17.0.0 mask 255.255.255.0 nomodify notrap # 放開局
			域⽹同步功能,172.17.0.0是你的局域⽹⽹段
			 server 127.127.1.0 # local clock
			 fudge 127.127.1.0 stratum 10
			3、重啟⽣效並配置ntpd服務開機⾃啟動
			 service ntpd restart
			 chkconfig ntpd on
			```
		- 集群中其他節點就可以從A服務器同步時間了
			```cmd
			ntpdate 172.17.0.17
			```
			




