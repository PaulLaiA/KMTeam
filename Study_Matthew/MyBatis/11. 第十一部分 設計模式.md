---
date: 2021-11-04
aliases: ["Mybatisè¨­è¨ˆæ¨¡å¼"]
---

# Metadata

**Title** :: è‡ªå®šç¾©æŒä¹…å±¤æ¡†æ¶

**Author** :: #Matthew 

**Classification** :: #Learn #Java #Basic

**Status** :: #ğŸŒ±

**Type** :: #Note

**Previous** ::[[Study_Matthew/MyBatis/10. ç¬¬åéƒ¨åˆ† Mybatisæºç¢¼åˆ†æ]]

**ParentNode** :: [[Study_Matthew/MyBatis/MyBatis|MyBatis]]

---


# ç¬¬åä¸€éƒ¨åˆ†ï¼š è¨­è¨ˆæ¨¡å¼
é›–ç„¶æˆ‘å€‘éƒ½çŸ¥é“æœ‰ 3 é¡ 23 ç¨®è¨­è¨ˆæ¨¡å¼ï¼Œä½†æ˜¯â¼¤å¤šåœç•™åœ¨æ¦‚å¿µå±¤â¾¯ï¼ŒMybatis æºç¢¼ä¸­ä½¿â½¤äº†â¼¤é‡çš„è¨­è¨ˆæ¨¡ å¼ï¼Œè§€å¯Ÿè¨­è¨ˆæ¨¡å¼åœ¨å…¶ä¸­çš„æ‡‰â½¤ï¼Œèƒ½å¤ æ›´æ·±â¼Šçš„ç†è§£è¨­è¨ˆæ¨¡å¼

Mybati s â¾„å°‘â½¤åˆ°äº†ä»¥ä¸‹çš„è¨­è¨ˆæ¨¡å¼çš„ä½¿â½¤ï¼š
![[Pasted image 20211003164315.png]]

æ¥ä¸‹ä¾†å° Builder æ§‹å»ºè€…æ¨¡å¼ã€â¼¯â¼šæ¨¡å¼ã€ä»£ç†æ¨¡å¼é€²â¾è§£è®€ï¼Œå…ˆä»‹ç´¹æ¨¡å¼â¾ƒèº«çš„çŸ¥è­˜ï¼Œç„¶å¾Œè§£è®€åœ¨ Mybatis ä¸­æ€æ¨£æ‡‰â½¤äº†è©²æ¨¡å¼ã€‚

## 11.1 Builder å»ºæ§‹è€…æ¨¡å¼

Builder æ¨¡å¼çš„å®šç¾©æ˜¯"å°‡â¼€å€‹è¤‡é›œå°è±¡çš„æ§‹å»ºèˆ‡å®ƒçš„è¡¨ç¤ºåˆ†é›¢ï¼Œä½¿å¾—åŒæ¨£çš„æ§‹å»ºéç¨‹å¯ä»¥å‰µå»ºä¸åŒçš„è¡¨ç¤ºã€‚â€ï¼Œå®ƒå±¬æ–¼å‰µå»ºé¡æ¨¡å¼ï¼Œâ¼€èˆ¬ä¾†èªªï¼Œå¦‚æœâ¼€å€‹å°è±¡çš„æ§‹å»ºâ½è¼ƒè¤‡é›œï¼Œè¶…å‡ºäº†æ§‹é€ å‡½æ•¸æ‰€èƒ½åŒ…å«çš„ç¯„ åœï¼Œå°±å¯ä»¥ä½¿â½¤â¼¯â¼šæ¨¡å¼å’Œ Builder æ¨¡å¼ï¼Œç›¸å°æ–¼â¼¯â¼šæ¨¡å¼æœƒç”¢å‡ºâ¼€å€‹å®Œæ•´çš„ç”¢å“ï¼ŒBuilder æ‡‰â½¤æ–¼æ›´åŠ  è¤‡é›œçš„å°è±¡çš„æ§‹å»ºï¼Œç”šâ¾„åªæœƒæ§‹å»ºç”¢å“çš„â¼€å€‹éƒ¨åˆ†ï¼Œç›´â½©ä¾†èªªï¼Œå°±æ˜¯ä½¿â½¤å¤šå€‹ç°¡å–®çš„å°è±¡â¼€æ­¥â¼€æ­¥æ§‹å»º æˆâ¼€å€‹è¤‡é›œçš„å°è±¡

ä¾‹â¼¦ï¼šä½¿â½¤æ§‹å»ºè€…è¨­è¨ˆæ¨¡å¼ä¾†â½£ç”¢ computer

ä¸»è¦æ­¥é©Ÿï¼š

	1ã€ å°‡éœ€è¦æ§‹å»ºçš„â½¬æ¨™é¡åˆ†æˆå¤šå€‹éƒ¨ä»¶ï¼ˆé›»è…¦å¯ä»¥åˆ†ç‚ºä¸»æ©Ÿã€é¡¯ç¤ºå™¨ã€éµç›¤ã€â¾³ç®±ç­‰éƒ¨ä»¶ï¼‰ï¼›
	2ã€ å‰µå»ºæ§‹å»ºé¡ï¼›
	3ã€ ä¾æ¬¡å‰µå»ºéƒ¨ä»¶ï¼›
	4ã€ å°‡éƒ¨ä»¶çµ„è£æˆâ½¬æ¨™å°è±¡
	
	
1. **å®šç¾© computer**
```java
package com.lagou.dao;
import org.apache.ibatis.binding.BindingException;
import org.apache.ibatis.session.SqlSession;
import java.util.Optional;
public class Computer {
 private String displayer;
 private String mainUnit;
 private String mouse;
 private String keyboard;
 public String getDisplayer() {
 return displayer;
 }
 public void setDisplayer(String displayer) {
 this.displayer = displayer;
 }
 public String getMainUnit() {
 return mainUnit;
 }
 public void setMainUnit(String mainUnit) {
 this.mainUnit = mainUnit;
 }
 public String getMouse() {
 return mouse;
 }
 public void setMouse(String mouse) {
 this.mouse = mouse;
 }
 public String getKeyboard() {
 return keyboard;
 }
 public void setKeyboard(String keyboard) {
 this.keyboard = keyboard;
 }
 @Override
 public String toString() {
 return "Computer{" + "displayer='" + displayer + '\'' + ", mainUnit='" + mainUnit + '\'' + ", mouse='" + mouse + '\'' + ", keyboard='" + keyboard + '\'' + '}';
 }
```

2. ComputerBuilder
```java
public static class ComputerBuilder {
 private ComputerBuilder target = new ComputerBuilder();
 public Builder installDisplayer(String displayer) {
 target.setDisplayer(displayer);
 return this;
 }
 public Builder installMainUnit(String mainUnit) {
 target.setMainUnit(mainUnit);
 return this;
 }
 public Builder installMouse(String mouse) {
 target.setMouse(mouse);
 return this;
 }
 public Builder installKeybord(String keyboard) {
 target.setKeyboard(keyboard);
 return this;
 }
 public ComputerBuilder build() {
 return target;
 }
}
```

**èª¿ç”¨**
```java
public static void main(String[]args){
 ComputerBuilder computerBuilder=new ComputerBuilder();
 computerBuilder.installDisplayer("æ˜¾ä¸‡å™¨");
 computerBuilder.installMainUnit("ä¸»æœº");
 computerBuilder.installKeybord("é”®ç›˜");
 computerBuilder.installMouse("â¿æ ‡");
 Computer computer=computerBuilder.Builder();
 System.out.println(computer);
}
```

**Mybatis ä¸­çš„é«”ç¾**

SqlSessionFactory çš„æ§‹å»ºéç¨‹ï¼š

Mybatis çš„åˆå§‹åŒ–â¼¯ä½œâ¾®å¸¸è¤‡é›œï¼Œä¸æ˜¯åªâ½¤â¼€å€‹æ§‹é€ å‡½æ•¸å°±èƒ½æå®šçš„ã€‚æ‰€ä»¥ä½¿â½¤äº†å»ºé€ è€…æ¨¡å¼ï¼Œä½¿â½¤äº†â¼¤é‡çš„ Builderï¼Œé€²â¾åˆ†å±¤æ§‹é€ ï¼Œæ ¸â¼¼å°è±¡ Configuration ä½¿â½¤äº† XmlConfigBuilder ä¾†é€²â¾æ§‹é€ 
![[Pasted image 20211003164719.png]]

åœ¨ Mybatis ç’°å¢ƒçš„åˆå§‹åŒ–éç¨‹ä¸­ï¼ŒSqlSessionFactoryBuilder æœƒèª¿â½¤ XMLConfigBuilder è®€å–æ‰€æœ‰çš„ MybatisMapConfig.xml å’Œæ‰€æœ‰çš„  Mapper.xml â½‚ä»¶ï¼Œæ§‹å»º Mybatis é‹â¾çš„æ ¸â¼¼å°è±¡ Configuration å° è±¡ï¼Œç„¶å¾Œ
å°‡è©² Configuration å°åƒä½œç‚ºåƒæ•¸æ§‹å»ºâ¼€å€‹ SqlSessionFactory å°è±¡ã€‚
```java
private void parseConfiguration(XNode root) {
try {
 //issue #117 read properties first
 //è§£æ <properties /> æ ‡ç­¾
 propertiesElement(root.evalNode("properties"));
 // è§£æ <settings /> æ ‡ç­¾
 Properties settings = settingsAsProperties(root.evalNode("settings"));
 //åŠ è½½â¾ƒå®šä¹‰çš„ VFS å®ç°ç±»
 loadCustomVfs(settings);
 // è§£æ <typeAliases /> æ ‡ç­¾
 typeAliasesElement(root.evalNode("typeAliases"));
 //è§£æ <plugins /> æ ‡ç­¾
 pluginElement(root.evalNode("plugins"));
 // è§£æ <objectFactory /> æ ‡ç­¾
 objectFactoryElement(root.evaINode("obj ectFactory"));
 // è§£æ <objectWrapper Factory /> æ ‡ç­¾
 obj ectWrappe rFacto ryElement(root.evalNode("objectWrapperFactory"));
 // è§£æ <reflectorFactory /> æ ‡ç­¾
 reflectorFactoryElement(root.evalNode("reflectorFactory"));
 // èµ‹å€¼ <settings /> åˆ° Configuration å±æ€§
 settingsElement(settings);
 // read it after objectFactory and objectWrapperFactory issue #631
 // è§£æ <environments /> æ ‡ç­¾
 environmentsElement(root.evalNode("environments"));
 // è§£æ <databaseIdProvider /> æ ‡ç­¾
 databaseldProviderElement(root.evalNode("databaseldProvider"));
}
```

å…¶ä¸­ XMLConfigBuilder åœ¨æ§‹å»º Configuration å°è±¡æ™‚ï¼Œä¹Ÿæœƒèª¿â½¤ XMLMapperBuilder â½¤æ–¼è®€å–  Mapper â½‚ä»¶ï¼Œâ½½ XMLMapperBuilder æœƒä½¿â½¤ XMLStatementBuilder ä¾†è®€å–å’Œ build æ‰€æœ‰çš„ SQL èªå¥ã€‚
```java
//è§£æ <mappers /> æ ‡ç­¾
mapperElement(root.evalNode("mappers"));
```
åœ¨é€™å€‹éç¨‹ä¸­ï¼Œæœ‰â¼€å€‹ç›¸ä¼¼çš„ç‰¹é»ï¼Œå°±æ˜¯é€™äº› Builder æœƒè®€å–â½‚ä»¶æˆ–è€…é…ç½®ï¼Œç„¶å¾Œåšâ¼¤é‡çš„ XpathParser è§£æã€é…ç½®æˆ–èªæ³•çš„è§£æã€åå°„â½£æˆå°è±¡ã€å­˜â¼Šçµæœç·©å­˜ç­‰æ­¥é©Ÿï¼Œé€™éº¼å¤šçš„â¼¯ä½œéƒ½ä¸æ˜¯â¼€å€‹æ§‹é€ å‡½æ•¸æ‰€ èƒ½åŒ…æ‹¬çš„ï¼Œå› æ­¤â¼¤é‡
æ¡â½¤äº† Builder æ¨¡å¼ä¾†è§£æ±º
![[Pasted image 20211003164916.png]]

SqlSessionFactoryBuilder é¡æ ¹æ“šä¸åŒçš„è¼¸â¼Šåƒæ•¸ä¾†æ§‹å»º SqlSessionFactory é€™å€‹â¼¯â¼šå°è±¡


## 11.2 â¼¯å» æ¨¡å¼
åœ¨ Mybatis ä¸­â½å¦‚ SqlSessionFactory ä½¿â½¤çš„æ˜¯â¼¯â¼šæ¨¡å¼ï¼Œè©²â¼¯â¼šæ²’æœ‰é‚£éº¼è¤‡é›œçš„é‚è¼¯ï¼Œæ˜¯â¼€å€‹ç°¡å–®â¼¯â¼šæ¨¡å¼ã€‚

ç°¡å–®â¼¯â¼šæ¨¡å¼(Simple Factory Pattern)ï¼šâ¼œç¨±ç‚ºéœæ…‹â¼¯â¼šâ½…æ³•(Static Factory Method)æ¨¡å¼ï¼Œå®ƒå±¬æ–¼å‰µå»ºå‹æ¨¡å¼ã€‚

åœ¨ç°¡å–®â¼¯â¼šæ¨¡å¼ä¸­ï¼Œå¯ä»¥æ ¹æ“šåƒæ•¸çš„ä¸åŒè¿”å›ä¸åŒé¡çš„å¯¦ä¾‹ã€‚ç°¡å–®â¼¯â¼šæ¨¡å¼å°ˆâ»”å®šç¾©â¼€å€‹é¡ä¾†è² è²¬å‰µå»º å…¶ä»–é¡çš„å¯¦ä¾‹ï¼Œè¢«å‰µå»ºçš„å¯¦ä¾‹é€šå¸¸éƒ½å…·æœ‰å…±åŒçš„â½—é¡

ä¾‹â¼¦ï¼šâ½£ç”¢é›»è…¦

å‡è¨­æœ‰â¼€å€‹é›»è…¦çš„ä»£â¼¯â½£ç”¢å•†ï¼Œå®ƒâ½¬å‰å·²ç¶“å¯ä»¥ä»£â¼¯â½£ç”¢è¯æƒ³é›»è…¦äº†ï¼Œéš¨è‘—æ¥­å‹™çš„æ‹“å±•ï¼Œé€™å€‹ä»£â¼¯â½£ç”¢ å•†é‚„è¦â½£ç”¢æƒ æ™®çš„é›»è…¦ï¼Œæˆ‘å€‘å°±éœ€è¦â½¤â¼€å€‹å–®ç¨çš„é¡ä¾†å°ˆâ»”â½£ç”¢é›»è…¦ï¼Œé€™å°±â½¤åˆ°äº†ç°¡å–®â¼¯â¼šæ¨¡å¼ã€‚

ä¸‹â¾¯æˆ‘å€‘ä¾†å¯¦ç¾ç°¡å–®â¼¯â¼šæ¨¡å¼ï¼š

1. å‰µå»ºæŠ½è±¡ç”¢å“é¡ï¼š

æˆ‘å€‘å‰µå»ºâ¼€å€‹é›»è…¦çš„æŠ½è±¡ç”¢å“é¡ï¼Œä»–æœ‰â¼€å€‹æŠ½è±¡â½…æ³•â½¤æ–¼å•Ÿå‹•é›»è…¦ï¼š
```java
public abstract class Computer {
 /**
 *äº§å“çš„æŠ½è±¡â½…æ³•ï¼Œç”±å…·ä½“çš„äº§å“ç±»å»å®ç°
 */
 public abstract void start();
}
```

2. å‰µå»ºå…·é«”ç”¢å“é¡

æ¥è‘—æˆ‘å€‘å‰µå»ºå„å€‹å“ç‰Œçš„é›»è…¦ï¼Œä»–å€‘éƒ½ç¹¼æ‰¿äº†ä»–å€‘çš„â½—é¡ Computerï¼Œä¸¦å¯¦ç¾äº†â½—é¡çš„ start â½…æ³•ï¼š
```java
public class LenovoComputer extends Computer{
 @Override
 public void start() {
 System.out.println("è”æƒ³ç”µè„‘å¯åŠ¨");
}
```

```java
public class HpComputer extends Computer{
 @Override
 public void start() {
 System.out.println("æƒ æ™®ç”µè„‘å¯åŠ¨");
 }
}
```

3. å‰µå»ºå·¥å» é¡
æ¥ä¸‹ä¾†å‰µå»ºâ¼€å€‹â¼¯â¼šé¡ï¼Œå®ƒæä¾›äº†â¼€å€‹éœæ…‹â½…æ³• createComputer â½¤ä¾†â½£ç”¢é›»è…¦ã€‚ä½ åªéœ€è¦å‚³â¼Šä½ æƒ³â½£ ç”¢çš„é›»è…¦çš„å“ç‰Œï¼Œå®ƒå°±æœƒå¯¦ä¾‹åŒ–ç›¸æ‡‰å“ç‰Œçš„é›»è…¦å°è±¡
```java
import org.junit.runner.Computer;
public class ComputerFactory {
 public static Computer createComputer(String type){
 Computer mComputer=null;
 switch (type) {
 case "lenovo":
 mComputer=new LenovoComputer();
 break;
 case "hp":
 mComputer=new HpComputer();
 break;
 }
 return mComputer;
 }
}
```

å®¢æˆ¶ç«¯èª¿â½¤â¼¯â¼šé¡

å®¢æˆ¶ç«¯èª¿â½¤â¼¯â¼šé¡ï¼Œå‚³â¼Šâ€œhpâ€â½£ç”¢å‡ºæƒ æ™®é›»è…¦ä¸¦èª¿â½¤è©²é›»è…¦å°è±¡çš„ start â½…æ³•ï¼š
```java
public class CreatComputer {
public static void main(String[]args){
 ComputerFactory.createComputer("hp").start();
 }
}
```

**Mybatis é«”ç¾ï¼š**

Mybatis ä¸­åŸ·â¾ Sql èªå¥ã€ç²å– Mappersã€ç®¡ç†äº‹å‹™çš„æ ¸â¼¼æ¥â¼ SqlSession çš„å‰µå»ºéç¨‹ä½¿â½¤åˆ°äº†â¼¯â¼šæ¨¡ å¼ã€‚

æœ‰â¼€å€‹ SqlSessionFactory ä¾†è² è²¬ SqlSession çš„å‰µå»º
![[Pasted image 20211003165418.png]]

SqlSessionFactory

å¯ä»¥çœ‹åˆ°ï¼Œè©² Factory çš„ openSession ()â½…æ³•é‡è¼‰äº†å¾ˆå¤šå€‹ï¼Œåˆ†åˆ¥â½€æŒ autoCommitã€Executorã€Transaction ç­‰åƒæ•¸çš„è¼¸â¼Šï¼Œä¾†æ§‹å»ºæ ¸â¼¼çš„ SqlSession å°è±¡ã€‚

åœ¨ DefaultSqlSessionFactory çš„é»˜èªâ¼¯â¼šå¯¦ç¾â¾¥ï¼Œæœ‰â¼€å€‹â½…æ³•å¯ä»¥çœ‹å‡ºâ¼¯â¼šæ€éº¼ç”¢å‡ºâ¼€å€‹ç”¢å“:
```java
private SqlSession openSessionFromDataSource(ExecutorType execType,
 TransactionIsolationLevel level,boolean autoCommit){
 Transaction tx=null;
 try{
final Environment environment=configuration.getEnvironment();
final TransactionFactory transactionFactory=
 getTransactionFactoryFromEnvironment(environment);
 
tx=transactionFactory.newTransaction(environment.getDataSource(),level,autoCommit);
 //æ ¹æ®å‚æ•°åˆ›å»ºåˆ¶å®šç±»å‹çš„ Executor
final Executor executor=configuration.newExecutor(tx,execType);
 //è¿”å›çš„æ˜¯ DefaultSqlSession
 return new DefaultSqlSession(configuration,executor,autoCommit);
 }catch(Exception e){
 closeTransaction(tx); // may have fetched a connection so lets call
 close()
 throw ExceptionFactory.wrapException("Error opening session. Cause: "+
 e,e);
 }finally{
 ErrorContext.instance().reset();
 }
 }
```

é€™æ˜¯â¼€å€‹ openSession èª¿â½¤çš„åº•å±¤â½…æ³•ï¼Œè©²â½…æ³•å…ˆå¾ configuration è®€å–å°æ‡‰çš„ç’°å¢ƒé…ç½®ï¼Œç„¶å¾Œåˆå§‹åŒ–

TransactionFactory ç²å¾—â¼€å€‹ Transaction å°è±¡ï¼Œç„¶å¾Œé€šé Transaction ç²å–â¼€å€‹ Executor å°è±¡ï¼Œæœ€å¾Œé€šé configurationã€Executorã€æ˜¯å¦ autoCommit ä¸‰å€‹åƒæ•¸æ§‹å»ºäº† SqlSession



## 11.3 ä»£ç†æ¨¡å¼

ä»£ç†æ¨¡å¼(Proxy Pattern):çµ¦æŸâ¼€å€‹å°è±¡æä¾›â¼€å€‹ä»£ç†ï¼Œä¸¦ç”±ä»£ç†å°è±¡æ§åˆ¶å°åŸå°è±¡çš„å¼•â½¤ã€‚ä»£ç†æ¨¡å¼ çš„è‹±â½‚å«åš Proxyï¼Œå®ƒæ˜¯â¼€ç¨®å°è±¡çµæ§‹å‹æ¨¡å¼ï¼Œä»£ç†æ¨¡å¼åˆ†ç‚ºéœæ…‹ä»£ç†å’Œå‹•æ…‹ä»£ç†ï¼Œæˆ‘å€‘ä¾†ä»‹ç´¹å‹•æ…‹ä»£ç†

**èˆ‰ä¾‹ï¼š**

1. å‰µå»ºâ¼€å€‹æŠ½åƒé¡ï¼ŒPerson æ¥â¼ï¼Œä½¿å…¶æ“æœ‰â¼€å€‹æ²’æœ‰è¿”å›å€¼çš„ doSomething â½…æ³•
```java
 /**
 * æŠ½è±¡ç±»â¼ˆ
 */
public interface Person {
 void doSomething();
}
```

2. å‰µå»ºâ¼€å€‹åç‚º Bob çš„ Person æ¥â¼çš„å¯¦ç¾é¡ï¼Œä½¿å…¶å¯¦ç¾ doSomething â½…æ³•
```java
 /**
 * åˆ›å»ºâ¼€ä¸ªåä¸º Bob çš„â¼ˆçš„å®ç°ç±»
 */
public class Bob implements Person {
 public void doSomething() {
 System.out.println("Bob doing something!");
 }
}
```

3. å‰µå»º JDK å‹•æ…‹ä»£ç†é¡ï¼Œä½¿å…¶å¯¦ç¾ InvocationHandler æ¥â¼ã€‚æ“æœ‰â¼€å€‹åç‚º target çš„è®Šé‡ï¼Œä¸¦å‰µå»º getTa rget ç²å–ä»£ç†å°è±¡â½…æ³•
```java
/**
* JDK åŠ¨æ€ä»£ç†
* éœ€å®ç° InvocationHandler æ¥â¼ */
public class JDKDynamicProxy implements InvocationHandler {
 //è¢«ä»£ç†çš„å¯¹è±¡
 Person target;
 // JDKDynamicProxy æ„é€ å‡½æ•°
 public JDKDynamicProxy(Person person) { this.target = person;
 }
 //è·å–ä»£ç†å¯¹è±¡
 public Person getTarget() { return (Person)
 Proxy.newProxylnstance(target.getClass().getClassLoader(),
target.getClass().getInterfaces(), this);
 }
 //åŠ¨æ€ä»£ç† invoke â½…æ³•
 public Person invoke(Object proxy, Method method, Object[] args) throws Throwable {
 //è¢«ä»£ç†â½…æ³•å‰æ‰§â¾
 System.out.println("JDKDynamicProxy do something before!");
 //æ‰§â¾è¢«ä»£ç†çš„â½…æ³•
 Person result = (Person) method.invoke(target, args);
 //è¢«ä»£ç†â½…æ³•åæ‰§â¾
 System.out.println("JDKDynamicProxy do something after!"); return result;
 }
```

4. å‰µå»º JDK å‹•æ…‹ä»£ç†æ¸¬è©¦é¡ J DKDynamicTest
```java
/**
* JDK åŠ¨æ€ä»£ç†æµ‹è¯•
*/
public class JDKDynamicTest {
 public static void main(String[] args) {
 System.out.println("ä¸ä½¿â½¤ä»£ç†ç±»ï¼Œè°ƒâ½¤ doSomething â½…æ³•ã€‚");
 //ä¸ä½¿â½¤ä»£ç†ç±»
 Person person = new Bob();
 // è°ƒâ½¤ doSomething â½…æ³•
 person.doSomething();
 System.out.println("åˆ†å‰²çº¿-----------");
 System.out.println("ä½¿â½¤ä»£ç†ç±»ï¼Œè°ƒâ½¤ doSomething â½…æ³•ã€‚");
 //è·å–ä»£ç†ç±»
 Person proxyPerson = new JDKDynamicProxy(new Bob()).getTarget();
 // è°ƒâ½¤ doSomething â½…æ³• proxyPerson.doSomething();
 }
}
```

**Mybatis ä¸­å¯¦ç¾ï¼š**

ä»£ç†æ¨¡å¼å¯ä»¥èªç‚ºæ˜¯ Mybatis çš„æ ¸â¼¼ä½¿â½¤çš„æ¨¡å¼ï¼Œæ­£æ˜¯ç”±æ–¼é€™å€‹æ¨¡å¼ï¼Œæˆ‘å€‘åªéœ€è¦ç·¨å¯« Mapper.java æ¥ â¼ï¼Œä¸éœ€è¦å¯¦ç¾ï¼Œç”± Mybati s å¾Œå°å¹«æˆ‘å€‘å®Œæˆå…·é«” SQL çš„åŸ·â¾ã€‚

ç•¶æˆ‘å€‘ä½¿â½¤ Configuration çš„ getMapper â½…æ³•æ™‚ï¼Œæœƒèª¿â½¤ mapperRegistry.getMapper â½…æ³•ï¼Œâ½½è©²â½…æ³•â¼œæœƒèª¿â½¤ mapperProxyFactory.newInstance(sqlSession)ä¾†â½£æˆâ¼€å€‹å…·é«”çš„ä»£ç†ï¼š
```java
public class MapperProxyFactory<T> {
 private final Class<T> mapperInterface;
 private final Map<Method, MapperMethod> methodCache = new
 ConcurrentHashMap<Method, MapperMethod>();
 public MapperProxyFactory(Class<T> mapperInterface) {
 this.mapperInterface = mapperInterface;
 }
 public Class<T> getMapperInterface() {
 return mapperInterface;
 }
 public Map<Method, MapperMethod> getMethodCache() {
 return methodCache;
 @SuppressWarnings("unchecked")
 protected T newInstance(MapperProxy<T> mapperProxy) {
 return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new
 Class[] { mapperInterface },
 mapperProxy);
 }
 public T newInstance(SqlSession sqlSession) {
 final MapperProxy<T> mapperProxy = new MapperProxy<T>(sqlSession,
mapperInterface, methodCache);
 return newInstance(mapperProxy);
 }
 }
```

åœ¨é€™â¾¥ï¼Œå…ˆé€šé T newInstance(SqlSession sqlSession)â½…æ³•æœƒå¾—åˆ°â¼€å€‹ MapperProxy å°è±¡ï¼Œç„¶å¾Œèª¿â½¤ TnewInstance(MapperProxy mapperProxy)â½£æˆä»£ç†å°è±¡ç„¶å¾Œè¿”å›ã€‚ 

â½½æŸ¥çœ‹ MapperProxy çš„ä»£ç¢¼ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å…§å®¹ï¼š
```java
public class MapperProxy<T> implements InvocationHandler, Serializable {
 @Override
 public Object invoke(Object proxy, Method method, Object[] args) throws
 Throwable {
 try {
 if (Object.class.equals(method.getDeclaringClass())) {
 return method.invoke(this, args);
 } else if (isDefaultMethod(method)) {
 return invokeDefaultMethod(proxy, method, args);
 }
 } catch (Throwable t) {
 throw ExceptionUtil.unwrapThrowable(t);
 }
 final MapperMethod mapperMethod = cachedMapperMethod(method);
 return mapperMethod.execute(sqlSession, args);
 }
```

â¾®å¸¸å…¸å‹çš„ï¼Œè©² MapperProxy é¡å¯¦ç¾äº† InvocationHandler æ¥â¼ï¼Œä¸¦ä¸”å¯¦ç¾äº†è©²æ¥â¼çš„ invoke â½…æ³•ã€‚

é€šéé€™ç¨®â½…å¼ï¼Œæˆ‘å€‘åªéœ€è¦ç·¨å¯« Mapper.java æ¥â¼é¡ï¼Œç•¶çœŸæ­£åŸ·â¾â¼€å€‹ Mapper æ¥â¼çš„æ™‚å€™ï¼Œå°±æœƒè½‰ç™¼çµ¦ MapperProxy.invoke â½…æ³•ï¼Œ

â½½è©²â½…æ³•å‰‡æœƒèª¿â½¤å¾ŒçºŒçš„ sqlSession.cud>executor.execute>prepareStatement ç­‰â¼€ç³»åˆ—â½…æ³•ï¼Œå®Œæˆ SQL çš„åŸ·â¾å’Œè¿”å›


















