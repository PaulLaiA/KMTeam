---
date: 2021-11-13
aliases: []
---

# Metadata

**Title** :: Java åŸºç¤ç­†è¨˜æ¨¡æ¿

**Author** :: #Matthew 

**Classification** :: #Learn #Java #Basic #SpringFramework/#SpringBoot 

**Status** :: #ğŸŒ±

**Type** :: #Note

**Previous** ::

**ParentNode** :: [[Study_Matthew/SpringBoot/SpringBoot]]

---


# 4. SpringBoot ç·©å­˜æ·±å…¥

## 4.1 JSR107
JSRæ˜¯Java Specification Requests çš„ç¸®å¯« ï¼ŒJavaè¦ç¯„è«‹æ±‚ï¼Œæ•…åæ€è­°æäº¤Javaè¦ç¯„ï¼Œ JSR-107å‘¢?

å°±æ˜¯é—œæ–¼å¦‚ä½•ä½¿ç”¨ç·©å­˜çš„è¦ç¯„ï¼Œæ˜¯javaæä¾›çš„ä¸€å€‹æ¥å£è¦ç¯„ï¼Œé¡ä¼¼æ–¼JDBCè¦ç¯„ï¼Œæ²’æœ‰å…·é«”çš„å¯¦ç¾ï¼Œå…·é«”çš„å¯¦ç¾å°±æ˜¯reidsç­‰é€™äº›ç·©å­˜ã€‚

### 4.1.1 JSR107æ ¸å¿ƒæ¥å£
Java Cachingï¼ˆJSR-107ï¼‰å®šç¾©äº†5å€‹æ ¸å¿ƒæ¥å£ï¼Œåˆ†åˆ¥æ˜¯CachingProviderã€CacheManagerã€Cacheã€Entryå’ŒExpiryã€‚

- CachingProviderï¼ˆç·©å­˜æä¾›è€…ï¼‰ï¼šå‰µå»ºã€é…ç½®ã€ç²å–ã€ç®¡ç†å’Œæ§åˆ¶å¤šå€‹CacheManager

- CacheManagerï¼ˆç·©å­˜ç®¡ç†å™¨ï¼‰ï¼šå‰µå»ºã€é…ç½®ã€ç²å–ã€ç®¡ç†å’Œæ§åˆ¶å¤šå€‹å”¯ä¸€å‘½åçš„Cacheï¼ŒCacheå­˜åœ¨æ–¼CacheManagerçš„ä¸Šä¸‹æ–‡ä¸­ã€‚ä¸€å€‹CacheManageråƒ…å°æ‡‰ä¸€å€‹CachingProvider

- Cacheï¼ˆç·©å­˜ï¼‰ï¼šæ˜¯ç”±CacheManagerç®¡ç†çš„ï¼ŒCacheManagerç®¡ç†Cacheçš„ç”Ÿå‘½é€±æœŸï¼ŒCacheå­˜åœ¨æ–¼CacheManagerçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæ˜¯ä¸€å€‹é¡ä¼¼mapçš„æ•¸æ“šçµæ§‹ï¼Œä¸¦è‡¨æ™‚å­˜å„²ä»¥keyç‚ºç´¢å¼•çš„å€¼ã€‚ä¸€å€‹Cacheåƒ…è¢«ä¸€å€‹CacheManageræ‰€æ“æœ‰

- Entryï¼ˆç·©å­˜éµå€¼å°ï¼‰ï¼šæ˜¯ä¸€å€‹å­˜å„²åœ¨Cacheä¸­çš„key-valueå°

- Expiryï¼ˆç·©å­˜æ™‚æ•ˆï¼‰ï¼šæ¯ä¸€å€‹å­˜å„²åœ¨Cacheä¸­çš„æ¢ç›®éƒ½æœ‰ä¸€å€‹å®šç¾©çš„æœ‰æ•ˆæœŸã€‚ä¸€æ—¦è¶…éé€™å€‹æ™‚é–“ï¼Œæ¢ç›®å°±è‡ªå‹•éæœŸï¼ŒéæœŸå¾Œï¼Œæ¢ç›®å°‡ä¸å¯ä»¥è¨ªå•ã€æ›´æ–°å’Œåˆªé™¤æ“ä½œã€‚ç·©å­˜æœ‰æ•ˆæœŸå¯ä»¥é€šéExpiryPolicyè¨­ç½®

### 4.1.2 JSR107åœ–ç¤º

![[Pasted image 20211113210027.png]]

ä¸€å€‹æ‡‰ç”¨è£¡é¢å¯ä»¥æœ‰å¤šå€‹ç·©å­˜æä¾›è€…(CachingProvider)ï¼Œä¸€å€‹ç·©å­˜æä¾›è€…å¯ä»¥ç²å–åˆ°å¤šå€‹ç·©å­˜ç®¡ç†å™¨(CacheManager)ï¼Œä¸€å€‹ç·©å­˜ç®¡ç†å™¨ç®¡ç†è‘—ä¸åŒçš„ç·©å­˜(Cache)ï¼Œç·©å­˜ä¸­æ˜¯ä¸€å€‹å€‹çš„ç·©å­˜éµå€¼å°(Entry)ï¼Œæ¯å€‹entryéƒ½æœ‰ä¸€å€‹æœ‰æ•ˆæœŸ(Expiry)ã€‚ç·©å­˜ç®¡ç†å™¨å’Œç·©å­˜ä¹‹é–“çš„é—œä¿‚æœ‰é»é¡ä¼¼æ–¼æ•¸æ“šåº«ä¸­é€£æ¥æ± å’Œé€£æ¥çš„é—œä¿‚ã€‚

ä½¿ç”¨JSR-107éœ€å°å…¥çš„ä¾è³´
```xml
<dependency>
	<groupId>javax.cache</groupId>
	<artifactId>cache-api</artifactId>
</dependency>
```


## 4.2 Springçš„ç·©å­˜æŠ½è±¡
### 4.2.1 ç·©å­˜æŠ½è±¡å®šç¾©
Springå¾3.1é–‹å§‹å®šç¾©äº†org.springframework.cache.Cache å’Œ org.springframework.cache.CacheManageræ¥å£ä¾†çµ±ä¸€ä¸åŒçš„ç·©å­˜æŠ€è¡“ï¼›ä¸¦æ”¯æŒä½¿ç”¨Java Cachingï¼ˆJSR-107ï¼‰è¨»è§£ç°¡åŒ–æˆ‘å€‘é€²è¡Œç·©å­˜é–‹ç™¼ã€‚

Spring Cache åªè² è²¬ç¶­è­·æŠ½è±¡å±¤ï¼Œå…·é«”çš„å¯¦ç¾ç”±è‡ªå·±çš„æŠ€è¡“é¸å‹ä¾†æ±ºå®šã€‚å°‡ç·©å­˜è™•ç†å’Œç·©å­˜æŠ€è¡“è§£é™¤è€¦åˆã€‚

æ¯æ¬¡èª¿ç”¨éœ€è¦ç·©å­˜åŠŸèƒ½çš„æ–¹æ³•æ™‚ï¼ŒSpringæœƒæª¢æŸ¥æŒ‡å®šåƒæ•¸çš„æŒ‡å®šçš„ç›®æ¨™æ–¹æ³•æ˜¯å¦å·²ç¶“è¢«èª¿ç”¨éï¼Œå¦‚æœæœ‰å°±ç›´æ¥å¾ç·©å­˜ä¸­ç²å–æ–¹æ³•èª¿ç”¨å¾Œçš„çµæœï¼Œå¦‚æœæ²’æœ‰å°±èª¿ç”¨æ–¹æ³•ä¸¦ç·©å­˜çµæœå¾Œè¿”å›çµ¦ç”¨æˆ¶ã€‚ä¸‹æ¬¡
èª¿ç”¨ç›´æ¥å¾ç·©å­˜ä¸­ç²å–ã€‚
â€ƒâ€ƒ
ä½¿ç”¨Springç·©å­˜æŠ½è±¡æ™‚æˆ‘å€‘éœ€è¦é—œæ³¨ä»¥ä¸‹å…©é»ï¼š
â€ƒâ€ƒâ€ƒ
â‘  ç¢ºå®šé‚£äº›æ–¹æ³•éœ€è¦è¢«ç·©å­˜
â€ƒâ€ƒâ€ƒ
â‘¡ ç·©å­˜ç­–ç•¥

### 4.2.2 é‡è¦æ¥å£
- Cacheï¼šç·©å­˜æŠ½è±¡çš„è¦ç¯„æ¥å£ï¼Œç·©å­˜å¯¦ç¾æœ‰ï¼šRedisCacheã€EhCacheã€ConcurrentMapCacheç­‰
- CacheManagerï¼šç·©å­˜ç®¡ç†å™¨ï¼Œç®¡ç†Cacheçš„ç”Ÿå‘½é€±æœŸ

## 4.3 Springç·©å­˜ä½¿ç”¨
### 4.3.1 é‡è¦æ¦‚å¿µ&ç·©å­˜è¨»è§£
æ¡ˆä¾‹å¯¦è¸ä¹‹å‰ï¼Œå…ˆä»‹ç´¹ä¸‹Springæä¾›çš„é‡è¦ç·©å­˜è¨»è§£åŠå¹¾å€‹é‡è¦æ¦‚å¿µ

å¹¾å€‹é‡è¦æ¦‚å¿µ&ç·©å­˜è¨»è§£ï¼š

æ¦‚å¿µ/è¨»è§£ |ä½œç”¨
--|--
Cache |ç·©å­˜æ¥å£ï¼Œå®šç¾©ç·©å­˜æ“ä½œã€‚å¯¦ç¾æœ‰ï¼šRedisCacheã€EhCacheCacheã€ConcurrentMapCacheç­‰
CacheManager |ç·©å­˜ç®¡ç†å™¨ï¼Œç®¡ç†å„ç¨®ç·©å­˜(Cache)çµ„ä»¶
@Cacheable |ä¸»è¦é‡å°æ–¹æ³•é…ç½®ï¼Œèƒ½å¤ æ ¹æ“šæ–¹æ³•çš„è«‹æ±‚åƒæ•¸å°å…¶çµæœé€²è¡Œç·©å­˜
@CacheEvict |æ¸…ç©ºç·©å­˜
@CachePut |ä¿è­‰æ–¹æ³•è¢«èª¿ç”¨ï¼Œåˆå¸Œæœ›çµæœè¢«ç·©å­˜ã€‚
@EnableCaching |é–‹å•ŸåŸºæ–¼è¨»è§£çš„ç·©å­˜
keyGenerator |ç·©å­˜æ•¸æ“šæ™‚keyç”Ÿæˆç­–ç•¥
serialize |ç·©å­˜æ•¸æ“šæ™‚valueåºåˆ—åŒ–ç­–ç•¥

#### èªªæ˜ï¼š
â‘  @Cacheableæ¨™è¨»åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºè©²æ–¹æ³•çš„çµæœéœ€è¦è¢«ç·©å­˜èµ·ä¾†ï¼Œç·©å­˜çš„éµç”±keyGeneratorçš„ç­–ç•¥æ±ºå®šï¼Œç·©å­˜çš„å€¼çš„å½¢å¼å‰‡ç”±serializeåºåˆ—åŒ–ç­–ç•¥æ±ºå®š(åºåˆ—åŒ–é‚„æ˜¯jsonæ ¼å¼)ï¼›æ¨™è¨»ä¸Šè©²è¨»è§£ä¹‹å¾Œï¼Œåœ¨ç·©å­˜æ™‚æ•ˆå…§å†æ¬¡èª¿ç”¨è©²æ–¹æ³•æ™‚å°‡ä¸æœƒèª¿ç”¨æ–¹æ³•æœ¬èº«è€Œæ˜¯ç›´æ¥å¾ç·©å­˜ç²å–çµæœ
â€ƒâ€ƒâ€ƒ
â‘¡ @CachePutä¹Ÿæ¨™è¨»åœ¨æ–¹æ³•ä¸Šï¼Œå’Œ@Cacheableç›¸ä¼¼ä¹Ÿæœƒå°‡æ–¹æ³•çš„è¿”å›å€¼ç·©å­˜èµ·ä¾†ï¼Œä¸åŒçš„æ˜¯æ¨™æ³¨@CachePutçš„æ–¹æ³•æ¯æ¬¡éƒ½æœƒè¢«èª¿ç”¨ï¼Œè€Œä¸”æ¯æ¬¡éƒ½æœƒå°‡çµæœç·©å­˜èµ·ä¾†ï¼Œé©ç”¨æ–¼å°è±¡çš„æ›´æ–°

### 4.3.2 ç’°å¢ƒæ­å»º
1. å‰µå»ºSpringBootæ‡‰ç”¨ï¼šé¸ä¸­Mysqlã€Mybatisã€Webæ¨¡å¡Š

2. å‰µå»ºæ•¸æ“šåº«è¡¨
	```sql
	SET FOREIGN_KEY_CHECKS=0;
	DROP TABLE IF EXISTS `department`;
	CREATE TABLE `department` (
	`id` int(11) NOT NULL AUTO_INCREMENT,
	`departmentName` varchar(255) DEFAULT NxQULL,
	PRIMARY KEY (`id`)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8;
	DROP TABLE IF EXISTS `employee`;
	CREATE TABLE `employee` (
	`id` int(11) NOT NULL AUTO_INCREMENT,
	`lastName` varchar(255) DEFAULT NULL,
	`email` varchar(255) DEFAULT NULL,
	`gender` int(2) DEFAULT NULL,
	`d_id` int(11) DEFAULT NULL,
	PRIMARY KEY (`id`)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8;
	```

3. å‰µå»ºè¡¨å°æ‡‰çš„å¯¦é«”Bean
	```java
	@Data
	public class Employee {
	private Integer id;
	private String lastName;
	private String email;
	private Integer gender; //æ€§åˆ« 1ç”· 0å¥³
	private Integer dId;
	}
	@Data
	public class Department {
	private Integer id;
	private String departmentName;
	}
	```

4. æ•´åˆmybatisæ“ä½œæ•°æ®åº“
	
	æ•¸æ“šæºé…ç½®ï¼šé©…å‹•å¯ä»¥ä¸å¯«ï¼ŒSpringBootæœƒæ ¹æ“šé€£æ¥è‡ªå‹•åˆ¤æ–·
	
	```properties
	spring.datasource.url=jdbc:mysql://localhost:3306/springboot_h
	spring.datasource.username=root
	spring.datasource.password=root
	#spring.datasource.driver-class-name=com.mysql.jdbc.Driver
	#å¼€å¯é©¼å³°å‘½å
	mybatis.configuration.map-underscore-to-camel-case=true
	```
	
	ä½¿ç”¨è¨»è§£ç‰ˆMybatisï¼šä½¿ç”¨@MapperScanæŒ‡å®šmapperæ¥å£æ‰€åœ¨çš„åŒ…
	```java
	@SpringBootApplication
	@MapperScan(basePackages = "com.lagou.cache.mappers")
	public class SpringbootCacheApplication {
		public static void main(String[] args) {
		  SpringApplication.run(SpringbootCacheApplication.class, args);
		}
	}
	```
	
	å‰µå»ºå°æ‡‰çš„mapperæ¥å£
	```java
	public interface EmployeeMapper {
		@Select("SELECT * FROM employee WHERE id = #{id}")
		public Employee getEmpById(Integer id);
		@Insert("INSERT INTO employee(lastName,email,gender,d_id) VALUES(#{lastName},#{email},#{gender},#{dId})")
		public void insertEmp(Employee employee);
		@Update("UPDATE employee SET lastName = #{lastName},email = #{email},gender = #{gender},d_id = #{dId} WHERE id = #{id}")
		public void updateEmp(Employee employee);
		@Delete("DELETE FROM employee WHERE id = #{id}")
		public void deleteEmpById(Integer id);
	}
	```
	
	ç¼–å†™Serviceï¼š
	```java
	@Service
	public class EmployeeService {
		@Autowired
		EmployeeMapper employeeMapper;
		public Employee getEmpById(Integer id){
			Employee emp = employeeMapper.getEmpById(id);
			return emp;
		}
	}
	```

	ç·¨å¯«Controllerï¼š
	```java
	@RestController
	public class EmployeeController {
		@Autowired
		EmployeeService employeeService;
		@GetMapping("/emp/{id}")
		public Employee getEmp(@PathVariable("id") Integer id){
			return employeeService.getEmpById(id);
		}
	}
	```

	æ¸¬è©¦ï¼š
	
	æ¸¬è©¦ä¹‹å‰å¯ä»¥å…ˆé…ç½®ä¸€ä¸‹Loggeræ—¥èªŒï¼Œè®“æ§åˆ¶å°å°‡Sqlæ‰“å°å‡ºä¾†ï¼š
	```properties
	logging.level.com.lagou.cache.mappers=debug
	```
	
	![[Pasted image 20211113212440.png]]

	çµè«–ï¼šç•¶å‰é‚„æ²’æœ‰çœ‹åˆ°ç·©å­˜æ•ˆæœï¼Œå› ç‚ºé‚„æ²’æœ‰é€²è¡Œç·©å­˜çš„ç›¸é—œè¨­ç½®
	
	
	
### 4.3.3 @Cacheableåˆé«”é©—

â‘  é–‹å•ŸåŸºæ–¼è¨»è§£çš„ç·©å­˜åŠŸèƒ½ï¼šä¸»å•Ÿå‹•é¡æ¨™è¨»@EnableCaching

```java
@SpringBootApplication
@MapperScan(basePackages = "com.lagou.cache.mappers")
@EnableCaching //å¼€å¯åŸºäºæ³¨è§£çš„ç¼“å­˜
public class SpringbootCacheApplication {
	public static void main(String[] args) {
	SpringApplication.run(SpringbootCacheApplication.class, args);
}
```

â‘¡ æ¨™è¨»ç·©å­˜ç›¸é—œè¨»è§£ï¼š@Cacheableã€CacheEvictã€CachePut
â€ƒâ€ƒâ€ƒ
@Cacheableï¼šå°‡æ–¹æ³•é‹è¡Œçš„çµæœé€²è¡Œç·©å­˜ï¼Œä»¥å¾Œå†ç²å–ç›¸åŒçš„æ•¸æ“šæ™‚ï¼Œç›´æ¥å¾ç·©å­˜ä¸­ç²å–ï¼Œä¸å†èª¿ç”¨æ–¹æ³•
```java
@Cacheable(cacheNames = {"emp"})
public Employee getEmpById(Integer id){
	Employee emp = employeeMapper.getEmpById(id);
	return emp;
}
```

@Cacheableè¨»è§£çš„å±¬æ€§ï¼š

å±¬æ€§å |æè¿°
--|--
cacheNames/value |æŒ‡å®šç·©å­˜çš„åå­—ï¼Œç·©å­˜ä½¿ç”¨CacheManagerç®¡ç†å¤šå€‹ç·©å­˜çµ„ä»¶Cacheï¼Œé€™äº›Cacheçµ„ä»¶å°±æ˜¯æ ¹æ“šé€™å€‹åå­—é€²è¡Œå€åˆ†çš„ã€‚å°ç·©å­˜çš„çœŸæ­£CRUDæ“ä½œåœ¨Cacheä¸­å®šç¾©ï¼Œæ¯å€‹ç·©å­˜çµ„ä»¶Cacheéƒ½æœ‰è‡ªå·±å”¯ä¸€çš„åå­—ï¼Œé€šécacheNamesæˆ–è€…valueå±¬æ€§æŒ‡å®šï¼Œç›¸ç•¶æ–¼æ˜¯å°‡ç·©å­˜çš„éµå€¼å°é€²è¡Œåˆ†çµ„ï¼Œç·©å­˜çš„åå­—æ˜¯ä¸€å€‹æ•¸çµ„ï¼Œä¹Ÿå°±æ˜¯èªªå¯ä»¥å°‡ä¸€å€‹ç·©å­˜éµå€¼å°åˆ†åˆ°å¤šå€‹çµ„è£¡é¢
key |ç·©å­˜æ•¸æ“šæ™‚çš„keyçš„å€¼ï¼Œé»˜èªæ˜¯ä½¿ç”¨æ–¹æ³•åƒæ•¸çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨SpELè¡¨é”å¼è¨ˆç®—keyçš„å€¼
keyGenerator |ç·©å­˜çš„ç”Ÿæˆç­–ç•¥ï¼Œå’ŒkeyäºŒé¸ä¸€ï¼Œéƒ½æ˜¯ç”Ÿæˆéµçš„ï¼ŒkeyGeneratorå¯è‡ªå®šç¾©
cacheManager | æŒ‡å®šç·©å­˜ç®¡ç†å™¨(å¦‚ConcurrentHashMapã€Redisç­‰)
cacheResolver | å’ŒcacheManageråŠŸèƒ½ä¸€æ¨£ï¼Œå’ŒcacheManageräºŒé¸ä¸€
condition | æŒ‡å®šç·©å­˜çš„æ¢ä»¶(æ»¿è¶³ä»€éº¼æ¢ä»¶æ™‚æ‰ç·©å­˜)ï¼Œå¯ç”¨SpELè¡¨é”å¼(å¦‚#id>0ï¼Œè¡¨ç¤ºç•¶å…¥åƒidå¤§æ–¼0æ™‚æ‰ç·©å­˜)
unless |å¦å®šç·©å­˜ï¼Œå³æ»¿è¶³unlessæŒ‡å®šçš„æ¢ä»¶æ™‚ï¼Œæ–¹æ³•çš„çµæœä¸é€²è¡Œç·©å­˜ï¼Œä½¿ç”¨unlessæ™‚å¯ä»¥åœ¨èª¿ç”¨çš„æ–¹æ³•ç²å–åˆ°çµæœä¹‹å¾Œå†é€²è¡Œåˆ¤æ–·(å¦‚#result==nullï¼Œè¡¨ç¤ºå¦‚æœçµæœç‚ºnullæ™‚ä¸ç·©å­˜)
sync | æ˜¯å¦ä½¿ç”¨ç•°æ­¥æ¨¡å¼é€²è¡Œç·©å­˜


æ³¨ï¼š
â€ƒâ€ƒ
â‘ æ—¢æ»¿è¶³conditionåˆæ»¿è¶³unlessæ¢ä»¶çš„ä¹Ÿä¸é€²è¡Œç·©å­˜

â‘¡ä½¿ç”¨ç•°æ­¥æ¨¡å¼é€²è¡Œç·©å­˜æ™‚(sync=true)ï¼šunlessæ¢ä»¶å°‡ä¸è¢«æ”¯æŒ
å¯ç”¨çš„SpELè¡¨é”å¼è¦‹ä¸‹è¡¨ï¼š

åå­—  |ä½ç½®  |æè¿°  |ç¤ºä¾‹
--|--|--|--
methodName |root object |ç•¶å‰è¢«èª¿ç”¨çš„æ–¹æ³•å | #root.methodName
method |rootã€object |ç•¶å‰è¢«èª¿ç”¨çš„æ–¹æ³• | #root.method.name
target |rootã€object |ç•¶å‰è¢«èª¿ç”¨çš„ç›®æ¨™å°è±¡ | #root.target
targetClass |rootã€object |ç•¶å‰è¢«èª¿ç”¨çš„ç›®æ¨™å°åƒé¡ | root.targetClass
args |rootã€object |ç•¶å‰è¢«èª¿ç”¨çš„æ–¹æ³•çš„åƒæ•¸åˆ—è¡¨ | #root.args[0]
caches |rootã€object |ç•¶å‰æ–¹æ³•èª¿ç”¨ä½¿ç”¨çš„ç·©å­˜åˆ—è¡¨ |(å¦‚@Cacheable(value={â€œcache1â€, â€œcache2â€}))ï¼Œå‰‡æœ‰å…©å€‹cache |#root.caches[0].name
argumentã€name |evaluationã€context |æ–¹æ³•åƒæ•¸çš„åå­—ï¼Œå¯ä»¥ç›´æ¥ #åƒæ•¸åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨#p0æˆ–#a0çš„å½¢å¼ï¼Œ0ä»£è¡¨åƒæ•¸çš„ç´¢å¼• |#ibanã€#a0ã€#p0
result |evaluationã€context |æ–¹æ³•åŸ·è¡Œå¾Œçš„è¿”å›å€¼(åƒ…ç•¶æ–¹æ³•åŸ·è¡Œä¹‹å¾Œçš„åˆ¤æ–·æœ‰æ•ˆï¼Œå¦‚"unless"ï¼Œ"cache put"çš„è¡¨é”å¼ï¼Œ"cache evict"çš„è¡¨é”å¼beforeInvocation=false) |#result

## 4.4 ç·©å­˜è‡ªå‹•é…ç½®åŸç†æºç¢¼å‰–æ
åœ¨springBootä¸­æ‰€æœ‰çš„è‡ªå‹•é…ç½®éƒ½æ˜¯ ...AutoConfiguration æ‰€ä»¥æˆ‘å€‘å»æœCacheAutoConfiguration é€™å€‹é¡

åœ¨é€™å€‹é¡ä¸­æœ‰ä¸€å€‹éœæ…‹å…§éƒ¨é¡ CacheConfigurationImportSelector ä»–æœ‰ä¸€å€‹ selectImport æ–¹æ³•æ˜¯ç”¨ä¾†çµ¦å®¹å™¨ä¸­æ·»åŠ ä¸€äº›ç·©å­˜è¦ç”¨çš„çµ„ä»¶;

![[Pasted image 20211114204557.png]]

![[Pasted image 20211114204616.png]]

![[Pasted image 20211114204625.png]]

æˆ‘å€‘åœ¨é€™è£¡æ‰“ä¸Šæ–·é»,debugèª¿è©¦ä¸€ä¸‹çœ‹çœ‹ imports ä¸­æœ‰å“ªäº›ç·©å­˜çµ„ä»¶

![[Pasted image 20211114204646.png]]

æˆ‘å€‘å¯ä»¥çœ‹åˆ°é€™è£¡ç¸½å…±æœ‰åå€‹ç·©å­˜çµ„ä»¶;æˆ‘å€‘éš¨ä¾¿å»çœ‹ä¸€å€‹

æœƒç™¼ç¾åœ¨ä»–çš„è¨»è§£ä¸Šè¡¨æ˜äº†ä»€éº¼æ™‚å€™ä½¿ç”¨é€™å€‹çµ„ä»¶;
```java
@Configuration(proxyBeanMethods = false)
@ConditionalOnClass(RedisConnectionFactory.class) // classpathä¸‹è¦å­˜åœ¨å¯¹åº”çš„classæ–‡ä»¶æ‰ä¼šè¿›è¡Œé…ç½®
@AutoConfigureAfter(RedisAutoConfiguration.class)
@ConditionalOnBean(RedisConnectionFactory.class)
@ConditionalOnMissingBean(CacheManager.class)
@Conditional(CacheCondition.class)
class RedisCacheConfiguration {
```

åå€‹ç·©å­˜çµ„ä»¶ï¼šæœ€çµ‚æœƒç™¼ç¾åªæœ‰ SimpleCacheConfiguration æ˜¯è¢«ä½¿ç”¨çš„,æ‰€ä»¥ä¹Ÿå°±èªªæ˜é»˜èªæƒ…æ³ä¸‹ä½¿ç”¨ SimpleCacheConfiguration ;
ç„¶å¾Œæˆ‘å€‘é€²å…¥åˆ° SimpleCacheConfiguration ä¸­ï¼š

```java
@Configuration(proxyBeanMethods = false)
@ConditionalOnMissingBean(CacheManager.class)
@Conditional(CacheCondition.class)
class SimpleCacheConfiguration {
	@Bean
	ConcurrentMapCacheManager cacheManager(CacheProperties cacheProperties,	CacheManagerCustomizers cacheManagerCustomizers) {
		ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager();
		List<String> cacheNames = cacheProperties.getCacheNames();
		if (!cacheNames.isEmpty()) {
			cacheManager.setCacheNames(cacheNames);
		}
		return cacheManagerCustomizers.customize(cacheManager);
	}
}
```

æˆ‘å€‘æœƒç™¼ç¾ä»–çµ¦springBootå®¹å™¨æ·»åŠ äº†ä¸€å€‹beanï¼Œæ˜¯ä¸€å€‹ CacheManager ;

ConcurrentMapCacheManager å¯¦ç¾äº† CacheManager æ¥å£

å†ä¾†çœ‹ ConcurrentMapCacheManager çš„getCacheæ–¹æ³•
```java
@Override
@Nullable
public Cache getCache(String name) {
	Cache cache = this.cacheMap.get(name);
	if (cache == null && this.dynamic) {
		synchronized (this.cacheMap) {
			cache = this.cacheMap.get(name);
			if (cache == null) {
				cache = createConcurrentMapCache(name);
				this.cacheMap.put(name, cache);
			}
		}
	}
	return cache;
}
```

getCache æ–¹æ³•ä½¿ç”¨äº†é›™é‡é–æ ¡é©—ï¼ˆé€™ç¨®é©—è­‰æ©Ÿåˆ¶ä¸€èˆ¬æ˜¯ç”¨åœ¨å–®ä¾‹æ¨¡å¼ä¸­ï¼‰

æˆ‘å€‘å¯ä»¥çœ‹åˆ°å¦‚æœæ²’æœ‰ Cache æœƒèª¿ç”¨

cache = this.createConcurrentMapCache(name);

```java
protected Cache createConcurrentMapCache(String name) {
	SerializationDelegate actualSerialization = (isStoreByValue() ? this.serialization : null);
	return new ConcurrentMapCache(name, new ConcurrentHashMap<>(256), isAllowNullValues(), actualSerialization);
}
```

é€™å€‹æ–¹æ³•æœƒå‰µå»ºä¸€å€‹ ConcurrentMapCache é€™å€‹å°±æ˜¯æˆ‘å€‘èªªçš„ Cache ;
```java
public class ConcurrentMapCache extends AbstractValueAdaptingCache {
	private final String name;
	private final ConcurrentMap<Object, Object> store;
	@Nullable
	private final SerializationDelegate serialization;
```

åœ¨è¿™ä¸ªç±»é‡Œé¢æœ‰è¿™æ ·ä¸‰ä¸ªå±æ€§;
```java
private final ConcurrentMap<Object, Object> store;
```

é€™å€‹å°±æ˜¯å‰æ–‡ä¸­çš„ Entry ç”¨ä¾†å­˜æ”¾éµå€¼å°;

åœ¨ ConcurrentMapCache ä¸­æˆ‘å€‘æœƒçœ‹åˆ°ä¸€äº›æ“ä½œ Cache çš„æ–¹æ³•,é¸å¹¾å€‹é‡è¦çš„
```java
@Override
@Nullable
protected Object lookup(Object key) {
	return this.store.get(key);
}
```

lookup æ–¹æ³•æ˜¯æ ¹æ“škeyä¾†æ‰¾valueçš„;
```java
@Override
public void put(Object key, @Nullable Object value) {
	this.store.put(key, toStoreValue(value));
}
```

put æ–¹æ³•é¡§åæ€ç¾©æ˜¯ç”¨ä¾†æ·»åŠ éµå€¼å°çš„;

åˆ°é€™é‡ŒåŸºæœ¬ä¸Šå°±çµæŸäº†,æ¥ä¸‹ä¾†æˆ‘å€‘ä¾†è©³ç´°åˆ†æä¸€ä¸‹ @Cacheable è¨»è§£


## 4.5 @Cacheableæºç¢¼åˆ†æ
æˆ‘å€‘åœ¨ä¸Šè¿°çš„å…©å€‹æ–¹æ³•ä¸Šæ‰“ä¸Šæ–·é»;debugé‹è¡ŒspringBoot;

è¨ªå•getEmpæ¥å£;
![[Pasted image 20211114205323.png]]

æˆ‘å€‘æœƒç™¼ç¾ä»–ä¾†åˆ°äº† lookup æ–¹æ³•é€™è£¡,èªªæ˜è¨»è§£çš„åŸ·è¡Œåœ¨è¢«è¨»è§£çš„æ–¹æ³•å‰,ç„¶å¾Œé€™è£¡æˆ‘å€‘æœƒè¿”å› nullï¼›
æˆ‘å€‘æ”¾è¡Œåˆ°ä¸‹ä¸€å€‹è¨»è§£æœƒç™¼ç¾;èª¿ç”¨äº†putæ–¹æ³•
![[Pasted image 20211114205348.png]]

æ·»åŠ äº†Cache; ç„¶å¾Œæˆ‘å€‘ç¬¬äºŒæ¬¡å°getEmpæ¥å£ç™¼èµ·è«‹æ±‚æˆ‘å€‘æœƒç™¼ç¾é€™ä¸€æ¬¡ç·©å­˜å…§å®¹ä¸å†ç‚ºnull
![[Pasted image 20211114205405.png]]

@Cacheableé‹è¡Œæµç¨‹ï¼š
â€ƒâ€ƒ
â‘ æ–¹æ³•é‹è¡Œä¹‹å‰ï¼Œå…ˆå»æŸ¥è©¢Cache(ç·©å­˜çµ„ä»¶)ï¼ŒæŒ‰ç…§cacheNamesæŒ‡å®šçš„åå­—ç²å–(CacheManager å…ˆç²å–ç›¸æ‡‰çš„ç·©å­˜ï¼Œç¬¬ä¸€æ¬¡ç²å–ç·©å­˜å¦‚æœæ²’æœ‰Cacheçµ„ä»¶æœƒè‡ªå‹•å‰µå»º)
â€ƒâ€ƒ
â‘¡å»Cacheä¸­æŸ¥æ‰¾ç·©å­˜çš„å…§å®¹ï¼Œä½¿ç”¨çš„keyé»˜èªå°±æ˜¯æ–¹æ³•çš„åƒæ•¸ï¼š
â€ƒâ€ƒâ€ƒ
keyé»˜èªæ˜¯ä½¿ç”¨keyGeneratorç”Ÿæˆçš„ï¼Œé»˜èªä½¿ç”¨çš„æ˜¯SimpleKeyGenerator
â€ƒâ€ƒâ€ƒ
SimpleKeyGeneratorç”Ÿæˆkeyçš„é»˜èªç­–ç•¥ï¼š
â€ƒâ€ƒâ€ƒâ€ƒ
å¦‚æœæ²’æœ‰åƒæ•¸ï¼škey = new SimpleKey()ï¼›
â€ƒâ€ƒâ€ƒâ€ƒ
å¦‚æœæœ‰ä¸€å€‹åƒæ•¸ï¼škey = åƒæ•¸çš„å€¼
â€ƒâ€ƒâ€ƒâ€ƒ
å¦‚æœæœ‰å¤šå€‹åƒæ•¸ï¼škey = new SimpleKey(params)ï¼›
â€ƒâ€ƒ
â‘¢æ²’æœ‰æŸ¥åˆ°ç·©å­˜å°±èª¿ç”¨ç›®æ¨™æ–¹æ³•
â€ƒâ€ƒ
â‘£å°‡ç›®æ¨™æ–¹æ³•è¿”å›çš„çµæœæ”¾é€²ç·©å­˜ä¸­
ç¸½çµ ï¼š@Cacheableæ¨™è¨»çš„æ–¹æ³•åœ¨åŸ·è¡Œä¹‹å‰æœƒå…ˆæª¢æŸ¥ç·©å­˜ä¸­æœ‰æ²’æœ‰é€™å€‹æ•¸æ“šï¼Œé»˜èªæŒ‰ç…§åƒæ•¸çš„å€¼ç‚ºkeyæŸ¥è©¢ç·©å­˜ï¼Œå¦‚æœæ²’æœ‰å°±é‹è¡Œæ–¹æ³•ä¸¦å°‡çµæœæ”¾å…¥ç·©å­˜ï¼Œä»¥å¾Œå†ä¾†èª¿ç”¨æ™‚ç›´æ¥ä½¿ç”¨ç·©å­˜ä¸­çš„æ•¸æ“šã€‚

**æ ¸å¿ƒï¼š**
â€ƒâ€ƒ
1ã€ä½¿ç”¨CacheManager(ConcurrentMapCacheManager)æŒ‰ç…§åå­—å¾—åˆ°Cache(ConcurrentMapCache)çµ„ä»¶
â€ƒâ€ƒ
2ã€keyä½¿ç”¨keyGeneratorç”Ÿæˆï¼Œé»˜èªä½¿ç”¨SimpleKeyGenerator

## 4.6 @CachePut&@CacheEvict&@CacheConfig
### @CachePut

1ã€èªªæ˜ï¼šæ—¢èª¿ç”¨æ–¹æ³•ï¼Œåˆæ›´æ–°ç·©å­˜æ•¸æ“šï¼Œä¸€èˆ¬ç”¨æ–¼æ›´æ–°æ“ä½œï¼Œåœ¨æ›´æ–°ç·©å­˜æ™‚ä¸€å®šè¦å’Œæƒ³æ›´æ–°çš„ç·©å­˜æœ‰ç›¸åŒçš„ç·©å­˜åç¨±å’Œç›¸åŒçš„key(å¯é¡æ¯”åŒä¸€å¼µè¡¨çš„åŒä¸€æ¢æ•¸æ“š)

2ã€é‹è¡Œæ™‚æ©Ÿï¼š
â€ƒâ€ƒ
â‘ å…ˆèª¿ç”¨ç›®æ¨™æ–¹æ³•
â€ƒâ€ƒ
â‘¡å°‡ç›®æ¨™æ–¹æ³•çš„çµæœç·©å­˜èµ·ä¾†

3ã€ç¤ºä¾‹ï¼š
```java
@CachePut(value = "emp",key = "#employee.id")
public Employee updateEmp(Employee employee){
	employeeMapper.updateEmp(employee);
	return employee;
}
```

ç¸½çµ ï¼š@CachePutæ¨™è¨»çš„æ–¹æ³•ç¸½æœƒè¢«èª¿ç”¨ï¼Œä¸”èª¿ç”¨ä¹‹å¾Œæ‰å°‡çµæœæ”¾å…¥ç·©å­˜ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨#resultç²å–åˆ°æ–¹æ³•çš„è¿”å›å€¼ã€‚

### @CacheEvict
1ã€èªªæ˜ï¼šç·©å­˜æ¸…é™¤ï¼Œæ¸…é™¤ç·©å­˜æ™‚è¦æŒ‡æ˜ç·©å­˜çš„åå­—å’Œkeyï¼Œç›¸ç•¶æ–¼å‘Šè¨´æ•¸æ“šåº«è¦åˆªé™¤å“ªå€‹è¡¨ä¸­çš„å“ªæ¢æ•¸æ“šï¼Œkeyé»˜èªç‚ºåƒæ•¸çš„å€¼

2ã€å±¬æ€§ï¼š
â€ƒâ€ƒ
value/cacheNamesï¼šç·©å­˜çš„åå­—
â€ƒâ€ƒ
keyï¼šç·©å­˜çš„éµ
â€ƒâ€ƒ
allEntriesï¼šæ˜¯å¦æ¸…é™¤æŒ‡å®šç·©å­˜ä¸­çš„æ‰€æœ‰éµå€¼å°ï¼Œé»˜èªç‚ºfalseï¼Œè¨­ç½®ç‚ºtrueæ™‚æœƒæ¸…é™¤ç·©å­˜ä¸­çš„æ‰€æœ‰éµå€¼å°ï¼Œèˆ‡keyå±¬æ€§äºŒé¸ä¸€ä½¿ç”¨

beforeInvocationï¼šåœ¨@CacheEvictè¨»è§£çš„æ–¹æ³•èª¿ç”¨ä¹‹å‰æ¸…é™¤æŒ‡å®šç·©å­˜ï¼Œé»˜èªç‚ºfalseï¼Œå³åœ¨æ–¹æ³•èª¿ç”¨ä¹‹å¾Œæ¸…é™¤ç·©å­˜ï¼Œè¨­ç½®ç‚ºtrueæ™‚å‰‡æœƒåœ¨æ–¹æ³•èª¿ç”¨ä¹‹å‰æ¸…é™¤ç·©å­˜(åœ¨æ–¹æ³•èª¿ç”¨ä¹‹å‰é‚„æ˜¯ä¹‹å¾Œæ¸…é™¤ç·©å­˜çš„å€åˆ¥åœ¨æ–¼æ–¹æ³•èª¿ç”¨æ™‚æ˜¯å¦æœƒå‡ºç¾ç•°å¸¸ï¼Œè‹¥ä¸å‡ºç¾ç•°å¸¸ï¼Œé€™å…©ç¨®è¨­ç½®æ²’æœ‰å€åˆ¥ï¼Œè‹¥å‡ºç¾ç•°å¸¸ï¼Œè¨­ç½®ç‚ºåœ¨æ–¹æ³•èª¿ç”¨ä¹‹å¾Œæ¸…é™¤ç·©å­˜å°‡ä¸èµ·ä½œç”¨ï¼Œå› ç‚ºæ–¹æ³•èª¿ç”¨å¤±æ•—äº†)

3ã€ç¤ºä¾‹ï¼š
```java
@CacheEvict(value = "emp",key = "#id",beforeInvocation = true)
public void delEmp(Integer id){
	employeeMapper.deleteEmpById(id);
}

```

### @CacheConfig
1ã€ä½œç”¨ï¼šæ¨™è¨»åœ¨é¡ä¸Šï¼ŒæŠ½å–ç·©å­˜ç›¸é—œè¨»è§£çš„å…¬å…±é…ç½®ï¼Œå¯æŠ½å–çš„å…¬å…±é…ç½®æœ‰ç·©å­˜åå­—ã€ä¸»éµç”Ÿæˆå™¨ç­‰(å¦‚è¨»è§£ä¸­çš„å±¬æ€§æ‰€ç¤º)
```java
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface CacheConfig {
	String[] cacheNames() default {};
	String keyGenerator() default "";
	String cacheManager() default "";
	String cacheResolver() default "";
}
```

2ã€ç¤ºä¾‹ï¼šé€šé@CacheConfigçš„cacheNames å±¬æ€§æŒ‡å®šç·©å­˜çš„åå­—ä¹‹å¾Œï¼Œè©²é¡ä¸­çš„å…¶ä»–ç·©å­˜æ³¨è§£å°±ä¸å¿…å†å¯«valueæˆ–è€…cacheNameäº†ï¼Œæœƒä½¿ç”¨è©²åå­—ä½œç‚ºvalueæˆ–cacheNameçš„å€¼ï¼Œç•¶ç„¶ä¹Ÿéµå¾ªå°±è¿‘åŸå‰‡
```java
@Service
@CacheConfig(cacheNames = "emp")
public class EmployeeService {
	@Autowired
	EmployeeMapper employeeMapper;
	@Cacheable
	public Employee getEmpById(Integer id) {
		Employee emp = employeeMapper.getEmpById(id);
		return emp;
	}
	@CachePut(key = "#employee.id")
	public Employee updateEmp(Employee employee) {
		employeeMapper.updateEmp(employee);
		return employee;
	}
	@CacheEvict(key = "#id", beforeInvocation = true)
	public void delEmp(Integer id) {
		employeeMapper.deleteEmpById(id);
	}
}
```


## 4.7 åŸºæ–¼Redisçš„ç·©å­˜å¯¦ç¾
SpringBooté»˜èªé–‹å•Ÿçš„ç·©å­˜ç®¡ç†å™¨æ˜¯ConcurrentMapCacheManagerï¼Œå‰µå»ºç·©å­˜çµ„ä»¶æ˜¯ConcurrentMapCacheï¼Œå°‡ç·©å­˜æ•¸æ“šä¿å­˜åœ¨ä¸€å€‹å€‹çš„ConcurrentHashMap<Object, Object>ä¸­ã€‚é–‹ç™¼æ™‚æˆ‘å€‘å¯ä»¥ä½¿ç”¨ç·©å­˜ä¸­é–“ä»¶ï¼šredisã€memcacheã€ehcacheç­‰ï¼Œé€™äº›ç·©å­˜ä¸­é–“ä»¶çš„å•Ÿç”¨å¾ˆç°¡å–®â€”â€”åªè¦å‘å®¹å™¨ä¸­åŠ å…¥ç›¸é—œçš„beanå°±æœƒå•Ÿç”¨ï¼Œå¯ä»¥å•Ÿç”¨å¤šå€‹ç·©å­˜ä¸­é–“ä»¶

### 4.7.1 å®‰è£å•Ÿå‹•Redis
![[Pasted image 20211114210431.png]]

### 4.7.2 æ•´åˆRedis
â‘ å¼•å…¥Redisçš„starter
```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

å¼•å…¥redisçš„starterä¹‹å¾Œï¼Œæœƒåœ¨å®¹å™¨ä¸­åŠ å…¥redisç›¸é—œçš„ä¸€äº›beanï¼Œå…¶ä¸­æœ‰å…©å€‹è·Ÿæ“ä½œredisç›¸é—œçš„ï¼š
RedisTemplateå’ŒStringRedisTemplate(ç”¨ä¾†æ“ä½œå­—ç¬¦ä¸²ï¼škeyå’Œvalueéƒ½æ˜¯å­—ç¬¦ä¸²)ï¼Œtemplateä¸­å°è£äº†æ“ä½œå„ç¨®æ•¸æ“šé¡å‹çš„æ“ä½œ(stringRredisTemplate.opsForValue()ã€stringRredisTemplate.opsForList()ç­‰)
```java
@Configuration
@ConditionalOnClass({JedisConnection.class, RedisOperations.class, Jedis.class})
@EnableConfigurationProperties({RedisProperties.class})
public class RedisAutoConfiguration {
	public RedisAutoConfiguration() {
	}
	
	@Configuration
	protected static class RedisConfiguration {
	protected RedisConfiguration() {
	}
		
	@Bean
	@ConditionalOnMissingBean(
		name = {"redisTemplate"}
	)
	public RedisTemplate<Object, Object>	redisTemplate(RedisConnectionFactory redisConnectionFactory) throws	UnknownHostException {
		RedisTemplate<Object, Object> template = new RedisTemplate();
		template.setConnectionFactory(redisConnectionFactory);
		return template;
	}
		
	@Bean
	@ConditionalOnMissingBean({StringRedisTemplate.class})
	public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory) throws UnknownHostException {
		StringRedisTemplate template = new StringRedisTemplate();
		template.setConnectionFactory(redisConnectionFactory);
		return template;
	}
}
//...

```

â‘¡é…ç½®redisï¼šåªéœ€è¦é…ç½®redisçš„ä¸»æ©Ÿåœ°å€(ç«¯å£é»˜èªå³ç‚º6379ï¼Œå› æ­¤å¯ä»¥ä¸æŒ‡å®š)
```properties
spring.redis.host=127.0.0.1
```

â‘¢æ¸¬è©¦ï¼š

è¨ªå•http://localhost:8080/emp/1

ä½¿ç”¨rediså­˜å„²å°è±¡æ™‚ï¼Œè©²å°è±¡å¿…é ˆå¯åºåˆ—åŒ–(å¯¦ç¾Serializableæ¥å£)ï¼Œå¦å‰‡æœƒå ±éŒ¯ï¼Œæ­¤æ™‚å­˜å„²çš„çµæœåœ¨redisçš„ç®¡ç†å·¥å…·ä¸­æŸ¥çœ‹å¦‚ä¸‹ï¼šç”±æ–¼åºåˆ—åŒ–çš„åŸå› å€¼å’Œéµéƒ½è®Šç‚ºäº†å¦å¤–ä¸€ç¨®å½¢å¼

![[Pasted image 20211114210806.png]]

SpringBooté»˜èªæ¡ç”¨çš„æ˜¯JDKçš„å°è±¡åºåˆ—åŒ–æ–¹å¼ï¼Œæˆ‘å€‘å¯ä»¥åˆ‡æ›ç‚ºä½¿ç”¨JSONæ ¼å¼é€²è¡Œå°è±¡çš„åºåˆ—åŒ–æ“ä½œï¼Œé€™æ™‚éœ€è¦æˆ‘å€‘è‡ªå®šç¾©åºåˆ—åŒ–è¦å‰‡(ç•¶ç„¶æˆ‘å€‘ä¹Ÿå¯ä»¥ä½¿ç”¨Jsonå·¥å…·å…ˆå°‡å°è±¡è½‰åŒ–ç‚ºJsonæ ¼å¼ä¹‹å¾Œå†ä¿å­˜è‡³redisï¼Œé€™æ¨£å°±ç„¡éœ€è‡ªå®šç¾©åºåˆ—åŒ–)

## 4.8 è‡ªå®šç¾©RedisCacheManager
### 4.8.1 Redisè¨»è§£é»˜èªåºåˆ—åŒ–æ©Ÿåˆ¶
æ‰“é–‹Spring Bootæ•´åˆRedisçµ„ä»¶æä¾›çš„ç·©å­˜è‡ªå‹•é…ç½®é¡

RedisCacheConfigurationï¼ˆorg.springframework.boot.autoconfigure.cacheåŒ…ä¸‹çš„ï¼‰ï¼ŒæŸ¥çœ‹è©²é¡çš„æºç¢¼ä¿¡æ¯ï¼Œå…¶æ ¸å¿ƒä»£ç¢¼å¦‚ä¸‹
```java
@Configuration
class RedisCacheConfiguration {
	@Bean
	public RedisCacheManager cacheManager(RedisConnectionFactory redisConnectionFactory,ResourceLoader resourceLoader) {
		RedisCacheManagerBuilder builder = RedisCacheManager.builder(redisConnectionFactory) .cacheDefaults(this.determineConfiguration(resourceLoader.getClassLoader()));
		List<String> cacheNames = this.cacheProperties.getCacheNames();
		if(!cacheNames.isEmpty()) {
			builder.initialCacheNames(new LinkedHashSet(cacheNames));
		}
		return (RedisCacheManager)this.customizerInvoker.customize(builder.build());
	}
	private org.springframework.data.redis.cache.RedisCacheConfiguration determineConfiguration(ClassLoader classLoader){
	if(this.redisCacheConfiguration != null) {
		return this.redisCacheConfiguration;
	} else {
		Redis redisProperties = this.cacheProperties.getRedis();
		org.springframework.data.redis.cache.RedisCacheConfiguration config = org.springframework.data.redis.cache.RedisCacheConfiguration.defaultCacheConfig();
		config = config.serializeValuesWith(SerializationPair.fromSerializer(
			new JdkSerializationRedisSerializer(classLoader)));
			...
		return config;
		}
	}
}
```

å¾ä¸Šè¿°æ ¸å¿ƒæºç¢¼ä¸­å¯ä»¥çœ‹å‡ºï¼ŒRedisCacheConfigurationå…§éƒ¨åŒæ¨£é€šéRedisé€£æ¥å·¥å» RedisConnectionFactoryå®šç¾©äº†ä¸€å€‹ç·©å­˜ç®¡ç†å™¨RedisCacheManagerï¼›åŒæ™‚å®šåˆ¶RedisCacheManageræ™‚ï¼Œä¹Ÿé»˜èªä½¿ç”¨äº†JdkSerializationRedisSerializeråºåˆ—åŒ–æ–¹å¼ã€‚

å¦‚æœæƒ³è¦ä½¿ç”¨è‡ªå®šç¾©åºåˆ—åŒ–æ–¹å¼çš„RedisCacheManageré€²è¡Œæ•¸æ“šç·©å­˜æ“ä½œï¼Œå¯ä»¥åƒè€ƒä¸Šè¿°æ ¸å¿ƒä»£ç¢¼å‰µå»ºä¸€å€‹åç‚ºcacheManagerçš„Beançµ„ä»¶ï¼Œä¸¦åœ¨è©²çµ„ä»¶ä¸­è¨­ç½®å°æ‡‰çš„åºåˆ—åŒ–æ–¹å¼å³å¯ 


### 4.8.2 è‡ªå®šç¾©RedisCacheManager
 åœ¨é …ç›®çš„Redisé…ç½®é¡RedisConfigä¸­ï¼ŒæŒ‰ç…§ä¸Šä¸€æ­¥åˆ†æçš„å®šåˆ¶æ–¹æ³•è‡ªå®šç¾©åç‚ºcacheManagerçš„Beançµ„ä»¶
```java
@Bean
public RedisCacheManager cacheManager(RedisConnectionFactory redisConnectionFactory) {
	// åˆ†åˆ«åˆ›å»ºStringå’ŒJSONæ ¼å¼åºåˆ—åŒ–å¯¹è±¡ï¼Œå¯¹ç¼“å­˜æ•°æ®keyå’Œvalueè¿›è¡Œè½¬æ¢
	RedisSerializer<String> strSerializer = new StringRedisSerializer();
	Jackson2JsonRedisSerializer jacksonSeial = new Jackson2JsonRedisSerializer(Object.class);
	// è§£å†³æŸ¥è¯¢ç¼“å­˜è½¬æ¢å¼‚å¸¸çš„é—®é¢˜
	ObjectMapper om = new ObjectMapper();
	om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
	om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);
	jacksonSeial.setObjectMapper(om);
	// å®šåˆ¶ç¼“å­˜æ•°æ®åºåˆ—åŒ–æ–¹å¼åŠæ—¶æ•ˆ
	RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
		.entryTtl(Duration.ofDays(1))
		.serializeKeysWith(RedisSerializationContext.SerializationPair
		.fromSerializer(strSerializer))
		.serializeValuesWith(RedisSerializationContext.SerializationPair
		.fromSerializer(jacksonSeial))
		.disableCachingNullValues();
	RedisCacheManager cacheManager = RedisCacheManager
		.builder(redisConnectionFactory).cacheDefaults(config).build();
	return cacheManager;
}
```

ä¸Šè¿°ä»£ç¢¼ä¸­ï¼Œåœ¨RedisConfigé…ç½®é¡ä¸­ä½¿ç”¨@Beanè¨»è§£æ³¨å…¥äº†ä¸€å€‹é»˜èªåç¨±ç‚ºæ–¹æ³•åçš„cacheManagerçµ„ä»¶ã€‚åœ¨å®šç¾©çš„Beançµ„ä»¶ä¸­ï¼Œé€šéRedisCacheConfigurationå°ç·©å­˜æ•¸æ“šçš„keyå’Œvalueåˆ†åˆ¥é€²è¡Œäº†åºåˆ—åŒ–æ–¹å¼çš„å®šåˆ¶ï¼Œå…¶ä¸­ç·©å­˜æ•¸æ“šçš„keyå®šåˆ¶ç‚ºStringRedisSerializerï¼ˆå³Stringæ ¼å¼ï¼‰ï¼Œè€Œvalueå®šåˆ¶ç‚ºäº†Jackson2JsonRedisSerializerï¼ˆå³JSONæ ¼å¼ï¼‰ï¼ŒåŒæ™‚é‚„ä½¿ç”¨entryTtl(Duration.ofDays(1))æ–¹æ³•å°‡ç·©å­˜æ•¸æ“šæœ‰æ•ˆæœŸè¨­ç½®ç‚º1å¤© 

 å®ŒæˆåŸºæ–¼è¨»è§£çš„Redisç·©å­˜ç®¡ç†å™¨RedisCacheManagerå®šåˆ¶å¾Œï¼Œå¯ä»¥å°è©²ç·©å­˜ç®¡ç†å™¨çš„æ•ˆæœé€²è¡Œæ¸¬è©¦ï¼ˆä½¿ç”¨è‡ªå®šç¾©åºåˆ—åŒ–æ©Ÿåˆ¶çš„RedisCacheManageræ¸¬è©¦æ™‚ï¼Œå¯¦é«”é¡å¯ä»¥ä¸ç”¨å¯¦ç¾åºåˆ—åŒ–æ¥å£ï¼‰
![[Pasted image 20211114211258.png]]


















