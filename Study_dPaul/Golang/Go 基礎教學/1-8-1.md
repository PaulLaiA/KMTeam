---
date: 2021-10-22
aliases: ["é—œéµè©ä¹‹ defer"]
---

# Metadata

**Title** 	  :: é—œéµè©ä¹‹ defer

**Author** :: #dPaulLai 

**Classification** :: #Learn #Go #Basic 

**Status**  :: #ğŸŒ 

**Type** 	:: #Note 

**Previous** :: 

**ParentNode** :: [[Go åŸºç¤æ•™å­¸]]

---

# defer
å¾ˆå¤šç°ä»£çš„ç¼–ç¨‹è¯­è¨€ä¸­éƒ½æœ‰ `defer` å…³é”®å­—ï¼ŒGo è¯­è¨€çš„ `defer` ä¼šåœ¨å½“å‰å‡½æ•°è¿”å›å‰æ‰§è¡Œä¼ å…¥çš„å‡½æ•°ï¼Œå®ƒä¼šç»å¸¸è¢«ç”¨äºå…³é—­æ–‡ä»¶æè¿°ç¬¦ã€å…³é—­æ•°æ®åº“è¿æ¥ä»¥åŠè§£é”èµ„æºã€‚è¿™ä¸€èŠ‚ä¼šæ·±å…¥ Go è¯­è¨€çš„æºä»£ç ä»‹ç» `defer` å…³é”®å­—çš„å®ç°åŸç†ï¼Œç›¸ä¿¡è¯»è€…è¯»å®Œè¿™ä¸€èŠ‚ä¼šå¯¹ `defer` çš„æ•°æ®ç»“æ„ã€å®ç°ä»¥åŠè°ƒç”¨è¿‡ç¨‹æœ‰ç€æ›´æ¸…æ™°çš„ç†è§£ã€‚

ä½œä¸ºä¸€ä¸ªç¼–ç¨‹è¯­è¨€ä¸­çš„å…³é”®å­—ï¼Œ`defer` çš„å®ç°ä¸€å®šæ˜¯ç”±ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶å…±åŒå®Œæˆçš„ï¼Œä¸è¿‡åœ¨æ·±å…¥æºç åˆ†æå®ƒçš„å®ç°ä¹‹å‰æˆ‘ä»¬è¿˜æ˜¯éœ€è¦äº†è§£ `defer` å…³é”®å­—çš„å¸¸è§ä½¿ç”¨åœºæ™¯ä»¥åŠä½¿ç”¨æ—¶çš„æ³¨æ„äº‹é¡¹ã€‚

ä½¿ç”¨ `defer` çš„æœ€å¸¸è§åœºæ™¯æ˜¯åœ¨å‡½æ•°è°ƒç”¨ç»“æŸåå®Œæˆä¸€äº›æ”¶å°¾å·¥ä½œï¼Œä¾‹å¦‚åœ¨ `defer` ä¸­å›æ»šæ•°æ®åº“çš„äº‹åŠ¡ï¼š

```go
func createPost(db *gorm.DB) error {
    tx := db.Begin()
    defer tx.Rollback()
    
    if err := tx.Create(&Post{Author: "Draveness"}).Error; err != nil {
        return err
    }
    
    return tx.Commit().Error
}
```

åœ¨ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„ä»£ç åœ¨åˆ›å»ºäº‹åŠ¡åå°±ç«‹åˆ»è°ƒç”¨ `Rollback` ä¿è¯äº‹åŠ¡ä¸€å®šä¼šå›æ»šã€‚å“ªæ€•äº‹åŠ¡çœŸçš„æ‰§è¡ŒæˆåŠŸäº†ï¼Œé‚£ä¹ˆè°ƒç”¨ `tx.Commit()` ä¹‹åå†æ‰§è¡Œ `tx.Rollback()` ä¹Ÿä¸ä¼šå½±å“å·²ç»æäº¤çš„äº‹åŠ¡ã€‚

## ç°è±¡

æˆ‘ä»¬åœ¨ Go è¯­è¨€ä¸­ä½¿ç”¨ `defer` æ—¶ä¼šé‡åˆ°ä¸¤ä¸ªå¸¸è§é—®é¢˜ï¼Œè¿™é‡Œä¼šä»‹ç»å…·ä½“çš„åœºæ™¯å¹¶åˆ†æè¿™ä¸¤ä¸ªç°è±¡èƒŒåçš„è®¾è®¡åŸç†ï¼š

-   `defer` å…³é”®å­—çš„è°ƒç”¨æ—¶æœºä»¥åŠå¤šæ¬¡è°ƒç”¨ `defer` æ—¶æ‰§è¡Œé¡ºåºæ˜¯å¦‚ä½•ç¡®å®šçš„ï¼›
-   `defer` å…³é”®å­—ä½¿ç”¨ä¼ å€¼çš„æ–¹å¼ä¼ é€’å‚æ•°æ—¶ä¼šè¿›è¡Œé¢„è®¡ç®—ï¼Œå¯¼è‡´ä¸ç¬¦åˆé¢„æœŸçš„ç»“æœï¼›

### ä½œç”¨åŸŸ

å‘ `defer` å…³é”®å­—ä¼ å…¥çš„å‡½æ•°ä¼šåœ¨å‡½æ•°è¿”å›ä¹‹å‰è¿è¡Œã€‚å‡è®¾æˆ‘ä»¬åœ¨ `for` å¾ªç¯ä¸­å¤šæ¬¡è°ƒç”¨ `defer` å…³é”®å­—ï¼š

```go
func main() {
	for i := 0; i < 5; i++ {
		defer fmt.Println(i)
	}
}
```
```bash
$ go run main.go
4
3
2
1
0
```

è¿è¡Œä¸Šè¿°ä»£ç ä¼šå€’åºæ‰§è¡Œä¼ å…¥ `defer` å…³é”®å­—çš„æ‰€æœ‰è¡¨è¾¾å¼ï¼Œå› ä¸ºæœ€åä¸€æ¬¡è°ƒç”¨ `defer` æ—¶ä¼ å…¥äº† `fmt.Println(4)`ï¼Œæ‰€ä»¥è¿™æ®µä»£ç ä¼šä¼˜å…ˆæ‰“å° 4ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªç®€å•ä¾‹å­å¼ºåŒ–å¯¹ `defer` æ‰§è¡Œæ—¶æœºçš„ç†è§£ï¼š

```go
func main() {
    {
        defer fmt.Println("defer runs")
        fmt.Println("block ends")
    }
    
    fmt.Println("main ends")
}

$ go run main.go
block ends
main ends
defer runs
```

ä»ä¸Šè¿°ä»£ç çš„è¾“å‡ºæˆ‘ä»¬ä¼šå‘ç°ï¼Œ`defer` ä¼ å…¥çš„å‡½æ•°ä¸æ˜¯åœ¨é€€å‡ºä»£ç å—çš„ä½œç”¨åŸŸæ—¶æ‰§è¡Œçš„ï¼Œå®ƒåªä¼šåœ¨å½“å‰å‡½æ•°å’Œæ–¹æ³•è¿”å›ä¹‹å‰è¢«è°ƒç”¨ã€‚

### é¢„è®¡ç®—å‚æ•°

Go è¯­è¨€ä¸­æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨éƒ½æ˜¯ä¼ å€¼çš„ï¼Œè™½ç„¶ `defer` æ˜¯å…³é”®å­—ï¼Œä½†æ˜¯ä¹Ÿç»§æ‰¿äº†è¿™ä¸ªç‰¹æ€§ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦è®¡ç®— `main` å‡½æ•°è¿è¡Œçš„æ—¶é—´ï¼Œå¯èƒ½ä¼šå†™å‡ºä»¥ä¸‹çš„ä»£ç ï¼š

```go
func main() {
	startedAt := time.Now()
	defer fmt.Println(time.Since(startedAt))
	
	time.Sleep(time.Second)
}

$ go run main.go
0s
```

ç„¶è€Œä¸Šè¿°ä»£ç çš„è¿è¡Œç»“æœå¹¶ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œè¿™ä¸ªç°è±¡èƒŒåçš„åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç»è¿‡åˆ†æï¼Œæˆ‘ä»¬ä¼šå‘ç°è°ƒç”¨ `defer` å…³é”®å­—ä¼šç«‹åˆ»æ‹·è´å‡½æ•°ä¸­å¼•ç”¨çš„å¤–éƒ¨å‚æ•°ï¼Œæ‰€ä»¥ `time.Since(startedAt)` çš„ç»“æœä¸æ˜¯åœ¨ `main` å‡½æ•°é€€å‡ºä¹‹å‰è®¡ç®—çš„ï¼Œè€Œæ˜¯åœ¨ `defer` å…³é”®å­—è°ƒç”¨æ—¶è®¡ç®—çš„ï¼Œæœ€ç»ˆå¯¼è‡´ä¸Šè¿°ä»£ç è¾“å‡º 0sã€‚

æƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å‘ `defer` å…³é”®å­—ä¼ å…¥åŒ¿åå‡½æ•°ï¼š

```go
func main() {
	startedAt := time.Now()
	defer func() { fmt.Println(time.Since(startedAt)) }()
	
	time.Sleep(time.Second)
}

$ go run main.go
1s
```

è™½ç„¶è°ƒç”¨ `defer` å…³é”®å­—æ—¶ä¹Ÿä½¿ç”¨å€¼ä¼ é€’ï¼Œä½†æ˜¯å› ä¸ºæ‹·è´çš„æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥ `time.Since(startedAt)` ä¼šåœ¨ `main` å‡½æ•°è¿”å›å‰è°ƒç”¨å¹¶æ‰“å°å‡ºç¬¦åˆé¢„æœŸçš„ç»“æœã€‚

## æ•°æ®ç»“æ„

åœ¨ä»‹ç» `defer` å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ä¸å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ `defer` å…³é”®å­—åœ¨ Go è¯­è¨€æºä»£ç ä¸­å¯¹åº”çš„æ•°æ®ç»“æ„ï¼š

```go
type _defer struct {
	siz       int32
	started   bool
	openDefer bool
	sp        uintptr
	pc        uintptr
	fn        *funcval
	_panic    *_panic
	link      *_defer
}
```

[`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“æ˜¯å»¶è¿Ÿè°ƒç”¨é“¾è¡¨ä¸Šçš„ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€æœ‰çš„ç»“æ„ä½“éƒ½ä¼šé€šè¿‡ `link` å­—æ®µä¸²è”æˆé“¾è¡¨ã€‚

![[Study_dPaul/Golang/Go åŸºç¤æ•™å­¸/_annex/Pasted image 20211103163553.png]]

**å›¾ 1 å»¶è¿Ÿè°ƒç”¨é“¾è¡¨**

æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“ä¸­çš„å‡ ä¸ªå­—æ®µï¼š

-   `siz` æ˜¯å‚æ•°å’Œç»“æœçš„å†…å­˜å¤§å°ï¼›
-   `sp` å’Œ `pc` åˆ†åˆ«ä»£è¡¨æ ˆæŒ‡é’ˆå’Œè°ƒç”¨æ–¹çš„ç¨‹åºè®¡æ•°å™¨ï¼›
-   `fn` æ˜¯ `defer` å…³é”®å­—ä¸­ä¼ å…¥çš„å‡½æ•°ï¼›
-   `_panic` æ˜¯è§¦å‘å»¶è¿Ÿè°ƒç”¨çš„ç»“æ„ä½“ï¼Œå¯èƒ½ä¸ºç©ºï¼›
-   `openDefer` è¡¨ç¤ºå½“å‰ `defer` æ˜¯å¦ç»è¿‡å¼€æ”¾ç¼–ç çš„ä¼˜åŒ–ï¼›

é™¤äº†ä¸Šè¿°çš„è¿™äº›å­—æ®µä¹‹å¤–ï¼Œ[`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ä¸­è¿˜åŒ…å«ä¸€äº›åƒåœ¾å›æ”¶æœºåˆ¶ä½¿ç”¨çš„å­—æ®µï¼Œè¿™é‡Œä¸ºäº†å‡å°‘ç†è§£çš„æˆæœ¬å°±éƒ½çœå»äº†ã€‚

## æ‰§è¡Œæœºåˆ¶

ä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µçš„ [`cmd/compile/internal/gc.state.stmt`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.stmt) ä¼šè´Ÿè´£å¤„ç†ç¨‹åºä¸­çš„ `defer`ï¼Œè¯¥å‡½æ•°ä¼šæ ¹æ®æ¡ä»¶çš„ä¸åŒï¼Œä½¿ç”¨ä¸‰ç§ä¸åŒçš„æœºåˆ¶å¤„ç†è¯¥å…³é”®å­—ï¼š

```go
func (s *state) stmt(n *Node) {
	...
	switch n.Op {
	case ODEFER:
		if s.hasOpenDefers {
			s.openDeferRecord(n.Left) // å¼€æ”¾ç¼–ç 
		} else {
			d := callDefer // å †åˆ†é…
			if n.Esc == EscNever {
				d = callDeferStack // æ ˆåˆ†é…
			}
			s.callResult(n.Left, d)
		}
	}
}
```

å †åˆ†é…ã€æ ˆåˆ†é…å’Œå¼€æ”¾ç¼–ç æ˜¯å¤„ç† `defer` å…³é”®å­—çš„ä¸‰ç§æ–¹æ³•ï¼Œæ—©æœŸçš„ Go è¯­è¨€ä¼šåœ¨å †ä¸Šåˆ†é… [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“ï¼Œä¸è¿‡è¯¥å®ç°çš„æ€§èƒ½è¾ƒå·®ï¼ŒGo è¯­è¨€åœ¨ 1.13 ä¸­å¼•å…¥æ ˆä¸Šåˆ†é…çš„ç»“æ„ä½“ï¼Œå‡å°‘äº† 30% çš„é¢å¤–å¼€é”€[1](https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/#fn:1)ï¼Œå¹¶åœ¨ 1.14 ä¸­å¼•å…¥äº†åŸºäºå¼€æ”¾ç¼–ç çš„ `defer`ï¼Œä½¿å¾—è¯¥å…³é”®å­—çš„é¢å¤–å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡[2](https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/#fn:2)ï¼Œæˆ‘ä»¬åœ¨ä¸€èŠ‚ä¸­ä¼šåˆ†åˆ«ä»‹ç»ä¸‰ç§ä¸åŒç±»å‹ `defer` çš„è®¾è®¡ä¸å®ç°åŸç†ã€‚

## å †ä¸Šåˆ†é…

æ ¹æ® [`cmd/compile/internal/gc.state.stmt`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.stmt) æ–¹æ³•å¯¹ `defer` çš„å¤„ç†æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå †ä¸Šåˆ†é…çš„ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“æ˜¯é»˜è®¤çš„å…œåº•æ–¹æ¡ˆï¼Œå½“è¯¥æ–¹æ¡ˆè¢«å¯ç”¨æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè°ƒç”¨ [`cmd/compile/internal/gc.state.callResult`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.callResult) å’Œ [`cmd/compile/internal/gc.state.call`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.call)ï¼Œè¿™è¡¨ç¤º `defer` åœ¨ç¼–è¯‘å™¨çœ‹æ¥ä¹Ÿæ˜¯å‡½æ•°è°ƒç”¨ã€‚

[`cmd/compile/internal/gc.state.call`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.call) ä¼šè´Ÿè´£ä¸ºæ‰€æœ‰å‡½æ•°å’Œæ–¹æ³•è°ƒç”¨ç”Ÿæˆä¸­é—´ä»£ç ï¼Œå®ƒçš„å·¥ä½œåŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š

1.  è·å–éœ€è¦æ‰§è¡Œçš„å‡½æ•°åã€é—­åŒ…æŒ‡é’ˆã€ä»£ç æŒ‡é’ˆå’Œå‡½æ•°è°ƒç”¨çš„æ¥æ”¶æ–¹ï¼›
2.  è·å–æ ˆåœ°å€å¹¶å°†å‡½æ•°æˆ–è€…æ–¹æ³•çš„å‚æ•°å†™å…¥æ ˆä¸­ï¼›
3.  ä½¿ç”¨ [`cmd/compile/internal/gc.state.newValue1A`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.newValue1A) ä»¥åŠç›¸å…³å‡½æ•°ç”Ÿæˆå‡½æ•°è°ƒç”¨çš„ä¸­é—´ä»£ç ï¼›
4.  å¦‚æœå½“å‰è°ƒç”¨çš„å‡½æ•°æ˜¯ `defer`ï¼Œé‚£ä¹ˆä¼šå•ç‹¬ç”Ÿæˆç›¸å…³çš„ç»“æŸä»£ç å—ï¼›
5.  è·å–å‡½æ•°çš„è¿”å›å€¼åœ°å€å¹¶ç»“æŸå½“å‰è°ƒç”¨ï¼›

```go
func (s *state) call(n *Node, k callKind, returnResultAddr bool) *ssa.Value {
	...
	var call *ssa.Value
	if k == callDeferStack {
		// åœ¨æ ˆä¸Šåˆå§‹åŒ– defer ç»“æ„ä½“
		...
	} else {
		...
		switch {
		case k == callDefer:
			aux := ssa.StaticAuxCall(deferproc, ACArgs, ACResults)
			call = s.newValue1A(ssa.OpStaticCall, types.TypeMem, aux, s.mem())
		...
		}
		call.AuxInt = stksize
	}
	s.vars[&memVar] = call
	...
}
```

ä»ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œ`defer` å…³é”®å­—åœ¨è¿è¡ŒæœŸé—´ä¼šè°ƒç”¨ [`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc)ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶äº†å‚æ•°çš„å¤§å°å’Œé—­åŒ…æ‰€åœ¨çš„åœ°å€ä¸¤ä¸ªå‚æ•°ã€‚

ç¼–è¯‘å™¨ä¸ä»…å°† `defer` å…³é”®å­—éƒ½è½¬æ¢æˆ [`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc) å‡½æ•°ï¼Œå®ƒè¿˜ä¼šé€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ä¸ºæ‰€æœ‰è°ƒç”¨ `defer` çš„å‡½æ•°æœ«å°¾æ’å…¥ [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) çš„å‡½æ•°è°ƒç”¨ï¼š

1.  [`cmd/compile/internal/gc.walkstmt`](https://draveness.me/golang/tree/cmd/compile/internal/gc.walkstmt) åœ¨é‡åˆ° `ODEFER` èŠ‚ç‚¹æ—¶ä¼šæ‰§è¡Œ `Curfn.Func.SetHasDefer(true)` è®¾ç½®å½“å‰å‡½æ•°çš„ `hasdefer` å±æ€§ï¼›
2.  [`cmd/compile/internal/gc.buildssa`](https://draveness.me/golang/tree/cmd/compile/internal/gc.buildssa) ä¼šæ‰§è¡Œ `s.hasdefer = fn.Func.HasDefer()` æ›´æ–° `state` çš„ `hasdefer`ï¼›
3.  [`cmd/compile/internal/gc.state.exit`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.exit) ä¼šæ ¹æ® `state` çš„ `hasdefer` åœ¨å‡½æ•°è¿”å›ä¹‹å‰æ’å…¥ [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) çš„å‡½æ•°è°ƒç”¨ï¼›

```go
func (s *state) exit() *ssa.Block {
	if s.hasdefer {
		...
		s.rtcall(Deferreturn, true, nil)
	}
	...
}
```

å½“è¿è¡Œæ—¶å°† [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) åˆ†é…åˆ°å †ä¸Šæ—¶ï¼ŒGo è¯­è¨€çš„ç¼–è¯‘å™¨ä¸ä»…å°† `defer` è½¬æ¢æˆäº† [`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc)ï¼Œè¿˜åœ¨æ‰€æœ‰è°ƒç”¨ `defer` çš„å‡½æ•°ç»“å°¾æ’å…¥äº† [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn)ã€‚ä¸Šè¿°ä¸¤ä¸ªè¿è¡Œæ—¶å‡½æ•°æ˜¯ `defer` å…³é”®å­—è¿è¡Œæ—¶æœºåˆ¶çš„å…¥å£ï¼Œå®ƒä»¬åˆ†åˆ«æ‰¿æ‹…äº†ä¸åŒçš„å·¥ä½œï¼š

-   [`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc) è´Ÿè´£åˆ›å»ºæ–°çš„å»¶è¿Ÿè°ƒç”¨ï¼›
-   [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) è´Ÿè´£åœ¨å‡½æ•°è°ƒç”¨ç»“æŸæ—¶æ‰§è¡Œæ‰€æœ‰çš„å»¶è¿Ÿè°ƒç”¨ï¼›

æˆ‘ä»¬ä»¥ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°ä¸ºå…¥å£ä»‹ç» `defer` å…³é”®å­—åœ¨è¿è¡Œæ—¶çš„æ‰§è¡Œè¿‡ç¨‹ä¸å·¥ä½œåŸç†ã€‚

### åˆ›å»ºå»¶è¿Ÿè°ƒç”¨

[`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc) ä¼šä¸º `defer` åˆ›å»ºä¸€ä¸ªæ–°çš„ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“ã€è®¾ç½®å®ƒçš„å‡½æ•°æŒ‡é’ˆ `fn`ã€ç¨‹åºè®¡æ•°å™¨ `pc` å’Œæ ˆæŒ‡é’ˆ `sp` å¹¶å°†ç›¸å…³çš„å‚æ•°æ‹·è´åˆ°ç›¸é‚»çš„å†…å­˜ç©ºé—´ä¸­ï¼š

```go
func deferproc(siz int32, fn *funcval) {
	sp := getcallersp()
	argp := uintptr(unsafe.Pointer(&fn)) + unsafe.Sizeof(fn)
	callerpc := getcallerpc()

	d := newdefer(siz)
	if d._panic != nil {
		throw("deferproc: d.panic != nil after newdefer")
	}
	d.fn = fn
	d.pc = callerpc
	d.sp = sp
	switch siz {
	case 0:
	case sys.PtrSize:
		*(*uintptr)(deferArgs(d)) = *(*uintptr)(unsafe.Pointer(argp))
	default:
		memmove(deferArgs(d), unsafe.Pointer(argp), uintptr(siz))
	}

	return0()
}
```

æœ€åè°ƒç”¨çš„ [`runtime.return0`](https://draveness.me/golang/tree/runtime.return0) æ˜¯å”¯ä¸€ä¸€ä¸ªä¸ä¼šè§¦å‘å»¶è¿Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œå®ƒå¯ä»¥é¿å…é€’å½’ [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) çš„é€’å½’è°ƒç”¨ã€‚

[`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc) ä¸­ [`runtime.newdefer`](https://draveness.me/golang/tree/runtime.newdefer) çš„ä½œç”¨æ˜¯æƒ³å°½åŠæ³•è·å¾— [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“ï¼Œè¿™é‡ŒåŒ…å«ä¸‰ç§è·¯å¾„ï¼š

1.  ä»è°ƒåº¦å™¨çš„å»¶è¿Ÿè°ƒç”¨ç¼“å­˜æ±  `sched.deferpool` ä¸­å–å‡ºç»“æ„ä½“å¹¶å°†è¯¥ç»“æ„ä½“è¿½åŠ åˆ°å½“å‰ Goroutine çš„ç¼“å­˜æ± ä¸­ï¼›
2.  ä» Goroutine çš„å»¶è¿Ÿè°ƒç”¨ç¼“å­˜æ±  `pp.deferpool` ä¸­å–å‡ºç»“æ„ä½“ï¼›
3.  é€šè¿‡ [`runtime.mallocgc`](https://draveness.me/golang/tree/runtime.mallocgc) åœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼›

```go
func newdefer(siz int32) *_defer {
	var d *_defer
	sc := deferclass(uintptr(siz))
	gp := getg()
	if sc < uintptr(len(p{}.deferpool)) {
		pp := gp.m.p.ptr()
		if len(pp.deferpool[sc]) == 0 && sched.deferpool[sc] != nil {
			for len(pp.deferpool[sc]) < cap(pp.deferpool[sc])/2 && sched.deferpool[sc] != nil {
				d := sched.deferpool[sc]
				sched.deferpool[sc] = d.link
				pp.deferpool[sc] = append(pp.deferpool[sc], d)
			}
		}
		if n := len(pp.deferpool[sc]); n > 0 {
			d = pp.deferpool[sc][n-1]
			pp.deferpool[sc][n-1] = nil
			pp.deferpool[sc] = pp.deferpool[sc][:n-1]
		}
	}
	if d == nil {
		total := roundupsize(totaldefersize(uintptr(siz)))
		d = (*_defer)(mallocgc(total, deferType, true))
	}
	d.siz = siz
	d.link = gp._defer
	gp._defer = d
	return d
}
```

æ— è®ºä½¿ç”¨å“ªç§æ–¹å¼ï¼Œåªè¦è·å–åˆ° [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“ï¼Œå®ƒéƒ½ä¼šè¢«è¿½åŠ åˆ°æ‰€åœ¨ Goroutine `_defer` é“¾è¡¨çš„æœ€å‰é¢ã€‚

![[Study_dPaul/Golang/Go åŸºç¤æ•™å­¸/_annex/Pasted image 20211103163610.png]]

**å›¾ 2 è¿½åŠ æ–°çš„å»¶è¿Ÿè°ƒç”¨**

`defer` å…³é”®å­—çš„æ’å…¥é¡ºåºæ˜¯ä»åå‘å‰çš„ï¼Œè€Œ `defer` å…³é”®å­—æ‰§è¡Œæ˜¯ä»å‰å‘åçš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåè°ƒç”¨çš„ `defer` ä¼šä¼˜å…ˆæ‰§è¡Œã€‚

### æ‰§è¡Œå»¶è¿Ÿè°ƒç”¨

[`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) ä¼šä» Goroutine çš„ `_defer` é“¾è¡¨ä¸­å–å‡ºæœ€å‰é¢çš„ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) å¹¶è°ƒç”¨ [`runtime.jmpdefer`](https://draveness.me/golang/tree/runtime.jmpdefer) ä¼ å…¥éœ€è¦æ‰§è¡Œçš„å‡½æ•°å’Œå‚æ•°ï¼š

```go
func deferreturn(arg0 uintptr) {
	gp := getg()
	d := gp._defer
	if d == nil {
		return
	}
	sp := getcallersp()
	...

	switch d.siz {
	case 0:
	case sys.PtrSize:
		*(*uintptr)(unsafe.Pointer(&arg0)) = *(*uintptr)(deferArgs(d))
	default:
		memmove(unsafe.Pointer(&arg0), deferArgs(d), uintptr(d.siz))
	}
	fn := d.fn
	gp._defer = d.link
	freedefer(d)
	jmpdefer(fn, uintptr(unsafe.Pointer(&arg0)))
}
```

[`runtime.jmpdefer`](https://draveness.me/golang/tree/runtime.jmpdefer) æ˜¯ä¸€ä¸ªç”¨æ±‡ç¼–è¯­è¨€å®ç°çš„è¿è¡Œæ—¶å‡½æ•°ï¼Œå®ƒçš„ä¸»è¦å·¥ä½œæ˜¯è·³è½¬åˆ° `defer` æ‰€åœ¨çš„ä»£ç æ®µå¹¶åœ¨æ‰§è¡Œç»“æŸä¹‹åè·³è½¬å› [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn)ã€‚

```go
TEXT runtimeÂ·jmpdefer(SB), NOSPLIT, $0-8
	MOVL	fv+0(FP), DX	// fn
	MOVL	argp+4(FP), BX	// caller sp
	LEAL	-4(BX), SP	// caller sp after CALL
#ifdef GOBUILDMODE_shared
	SUBL	$16, (SP)	// return to CALL again
#else
	SUBL	$5, (SP)	// return to CALL again
#endif
	MOVL	0(DX), BX
	JMP	BX	// but first run the deferred function
```

[`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) ä¼šå¤šæ¬¡åˆ¤æ–­å½“å‰ Goroutine çš„ `_defer` é“¾è¡¨ä¸­æ˜¯å¦æœ‰æœªæ‰§è¡Œçš„ç»“æ„ä½“ï¼Œè¯¥å‡½æ•°åªæœ‰åœ¨æ‰€æœ‰å»¶è¿Ÿå‡½æ•°éƒ½æ‰§è¡Œåæ‰ä¼šè¿”å›ã€‚

## æ ˆä¸Šåˆ†é…

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Go è¯­è¨€ä¸­ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“éƒ½ä¼šåœ¨å †ä¸Šåˆ†é…ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå°†éƒ¨åˆ†ç»“æ„ä½“åˆ†é…åˆ°æ ˆä¸Šå°±å¯ä»¥èŠ‚çº¦å†…å­˜åˆ†é…å¸¦æ¥çš„é¢å¤–å¼€é”€ã€‚

Go è¯­è¨€å›¢é˜Ÿåœ¨ 1.13 ä¸­å¯¹ `defer` å…³é”®å­—è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå½“è¯¥å…³é”®å­—åœ¨å‡½æ•°ä½“ä¸­æœ€å¤šæ‰§è¡Œä¸€æ¬¡æ—¶ï¼Œç¼–è¯‘æœŸé—´çš„ [`cmd/compile/internal/gc.state.call`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.call) ä¼šå°†ç»“æ„ä½“åˆ†é…åˆ°æ ˆä¸Šå¹¶è°ƒç”¨ [`runtime.deferprocStack`](https://draveness.me/golang/tree/runtime.deferprocStack)ï¼š

```go
func (s *state) call(n *Node, k callKind) *ssa.Value {
	...
	var call *ssa.Value
	if k == callDeferStack {
		// åœ¨æ ˆä¸Šåˆ›å»º _defer ç»“æ„ä½“
		t := deferstruct(stksize)
		...

		ACArgs = append(ACArgs, ssa.Param{Type: types.Types[TUINTPTR], Offset: int32(Ctxt.FixedFrameSize())})
		aux := ssa.StaticAuxCall(deferprocStack, ACArgs, ACResults) // è°ƒç”¨ deferprocStack
		arg0 := s.constOffPtrSP(types.Types[TUINTPTR], Ctxt.FixedFrameSize())
		s.store(types.Types[TUINTPTR], arg0, addr)
		call = s.newValue1A(ssa.OpStaticCall, types.TypeMem, aux, s.mem())
		call.AuxInt = stksize
	} else {
		...
	}
	s.vars[&memVar] = call
	...
}
```

å› ä¸ºåœ¨ç¼–è¯‘æœŸé—´æˆ‘ä»¬å·²ç»åˆ›å»ºäº† [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“ï¼Œæ‰€ä»¥åœ¨è¿è¡ŒæœŸé—´ [`runtime.deferprocStack`](https://draveness.me/golang/tree/runtime.deferprocStack) åªéœ€è¦è®¾ç½®ä¸€äº›æœªåœ¨ç¼–è¯‘æœŸé—´åˆå§‹åŒ–çš„å­—æ®µï¼Œå°±å¯ä»¥å°†æ ˆä¸Šçš„ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) è¿½åŠ åˆ°å‡½æ•°çš„é“¾è¡¨ä¸Šï¼š

```go
func deferprocStack(d *_defer) {
	gp := getg()
	d.started = false
	d.heap = false // æ ˆä¸Šåˆ†é…çš„ _defer
	d.openDefer = false
	d.sp = getcallersp()
	d.pc = getcallerpc()
	d.framepc = 0
	d.varp = 0
	*(*uintptr)(unsafe.Pointer(&d._panic)) = 0
	*(*uintptr)(unsafe.Pointer(&d.fd)) = 0
	*(*uintptr)(unsafe.Pointer(&d.link)) = uintptr(unsafe.Pointer(gp._defer))
	*(*uintptr)(unsafe.Pointer(&gp._defer)) = uintptr(unsafe.Pointer(d))

	return0()
}
```

é™¤äº†åˆ†é…ä½ç½®çš„ä¸åŒï¼Œæ ˆä¸Šåˆ†é…å’Œå †ä¸Šåˆ†é…çš„ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) å¹¶æ²¡æœ‰æœ¬è´¨çš„ä¸åŒï¼Œè€Œè¯¥æ–¹æ³•å¯ä»¥é€‚ç”¨äºç»å¤§å¤šæ•°çš„åœºæ™¯ï¼Œä¸å †ä¸Šåˆ†é…çš„ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç›¸æ¯”ï¼Œè¯¥æ–¹æ³•å¯ä»¥å°† `defer` å…³é”®å­—çš„é¢å¤–å¼€é”€é™ä½ ~30%ã€‚

## å¼€æ”¾ç¼–ç 

Go è¯­è¨€åœ¨ 1.14 ä¸­é€šè¿‡å¼€æ”¾ç¼–ç ï¼ˆOpen Codedï¼‰å®ç° `defer` å…³é”®å­—ï¼Œè¯¥è®¾è®¡ä½¿ç”¨ä»£ç å†…è”ä¼˜åŒ– `defer` å…³é”®çš„é¢å¤–å¼€é”€å¹¶å¼•å…¥å‡½æ•°æ•°æ® `funcdata` ç®¡ç† `panic` çš„è°ƒç”¨[3](https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/#fn:3)ï¼Œè¯¥ä¼˜åŒ–å¯ä»¥å°† `defer` çš„è°ƒç”¨å¼€é”€ä» 1.13 ç‰ˆæœ¬çš„ ~35ns é™ä½è‡³ ~6ns å·¦å³ï¼š

```go
With normal (stack-allocated) defers only:         35.4  ns/op
With open-coded defers:                             5.6  ns/op
Cost of function call alone (remove defer keyword): 4.4  ns/op
```

ç„¶è€Œå¼€æ”¾ç¼–ç ä½œä¸ºä¸€ç§ä¼˜åŒ– `defer` å…³é”®å­—çš„æ–¹æ³•ï¼Œå®ƒä¸æ˜¯åœ¨æ‰€æœ‰çš„åœºæ™¯ä¸‹éƒ½ä¼šå¼€å¯çš„ï¼Œå¼€æ”¾ç¼–ç åªä¼šåœ¨æ»¡è¶³ä»¥ä¸‹çš„æ¡ä»¶æ—¶å¯ç”¨ï¼š

1.  å‡½æ•°çš„ `defer` æ•°é‡å°‘äºæˆ–è€…ç­‰äº 8 ä¸ªï¼›
2.  å‡½æ•°çš„ `defer` å…³é”®å­—ä¸èƒ½åœ¨å¾ªç¯ä¸­æ‰§è¡Œï¼›
3.  å‡½æ•°çš„ `return` è¯­å¥ä¸ `defer` è¯­å¥çš„ä¹˜ç§¯å°äºæˆ–è€…ç­‰äº 15 ä¸ªï¼›

åˆçœ‹ä¸Šè¿°å‡ ä¸ªæ¡ä»¶å¯èƒ½ä¼šè§‰å¾—ä¸æ˜æ‰€ä»¥ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æ·±å…¥ç†è§£åŸºäºå¼€æ”¾ç¼–ç çš„ä¼˜åŒ–å°±å¯ä»¥æ˜ç™½ä¸Šè¿°é™åˆ¶èƒŒåçš„åŸå› ï¼Œé™¤äº†ä¸Šè¿°å‡ ä¸ªæ¡ä»¶ä¹‹å¤–ï¼Œä¹Ÿæœ‰å…¶ä»–çš„æ¡ä»¶ä¼šé™åˆ¶å¼€æ”¾ç¼–ç çš„ä½¿ç”¨ï¼Œä¸è¿‡è¿™äº›éƒ½æ˜¯ä¸å¤ªé‡è¦çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¹Ÿä¸ä¼šæ·±ç©¶ã€‚

### å¯ç”¨ä¼˜åŒ–

Go è¯­è¨€ä¼šåœ¨ç¼–è¯‘æœŸé—´å°±ç¡®å®šæ˜¯å¦å¯ç”¨å¼€æ”¾ç¼–ç ï¼Œåœ¨ç¼–è¯‘å™¨ç”Ÿæˆä¸­é—´ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ [`cmd/compile/internal/gc.walkstmt`](https://draveness.me/golang/tree/cmd/compile/internal/gc.walkstmt) ä¿®æ”¹å·²ç»ç”Ÿæˆçš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œè®¾ç½®å‡½æ•°ä½“ä¸Šçš„ `OpenCodedDeferDisallowed` å±æ€§ï¼š

```go
const maxOpenDefers = 8

func walkstmt(n *Node) *Node {
	switch n.Op {
	case ODEFER:
		Curfn.Func.SetHasDefer(true)
		Curfn.Func.numDefers++
		if Curfn.Func.numDefers > maxOpenDefers {
			Curfn.Func.SetOpenCodedDeferDisallowed(true)
		}
		if n.Esc != EscNever {
			Curfn.Func.SetOpenCodedDeferDisallowed(true)
		}
		fallthrough
	...
	}
}
```

å°±åƒæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ï¼Œå¦‚æœå‡½æ•°ä¸­ `defer` å…³é”®å­—çš„æ•°é‡å¤šäº 8 ä¸ªæˆ–è€… `defer` å…³é”®å­—å¤„äº `for` å¾ªç¯ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨è¿™é‡Œéƒ½ä¼šç¦ç”¨å¼€æ”¾ç¼–ç ä¼˜åŒ–ï¼Œä½¿ç”¨ä¸Šä¸¤èŠ‚æåˆ°çš„æ–¹æ³•å¤„ç† `defer`ã€‚

åœ¨ SSA ä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µçš„ [`cmd/compile/internal/gc.buildssa`](https://draveness.me/golang/tree/cmd/compile/internal/gc.buildssa) ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿçœ‹åˆ°å¯ç”¨å¼€æ”¾ç¼–ç ä¼˜åŒ–çš„å…¶ä»–æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¿”å›è¯­å¥çš„æ•°é‡ä¸ `defer` æ•°é‡çš„ä¹˜ç§¯éœ€è¦å°äº 15ï¼š

```go
func buildssa(fn *Node, worker int) *ssa.Func {
	...
	s.hasOpenDefers = s.hasdefer && !s.curfn.Func.OpenCodedDeferDisallowed()
	...
	if s.hasOpenDefers &&
		s.curfn.Func.numReturns*s.curfn.Func.numDefers > 15 {
		s.hasOpenDefers = false
	}
	...
}
```

ä¸­é—´ä»£ç ç”Ÿæˆçš„è¿™ä¸¤ä¸ªæ­¥éª¤ä¼šå†³å®šå½“å‰å‡½æ•°æ˜¯å¦åº”è¯¥ä½¿ç”¨å¼€æ”¾ç¼–ç ä¼˜åŒ– `defer` å…³é”®å­—ï¼Œä¸€æ—¦ç¡®å®šä½¿ç”¨å¼€æ”¾ç¼–ç ï¼Œå°±ä¼šåœ¨ç¼–è¯‘æœŸé—´åˆå§‹åŒ–å»¶è¿Ÿæ¯”ç‰¹å’Œå»¶è¿Ÿè®°å½•ã€‚

### å»¶è¿Ÿè®°å½•

å»¶è¿Ÿæ¯”ç‰¹å’Œå»¶è¿Ÿè®°å½•æ˜¯ä½¿ç”¨å¼€æ”¾ç¼–ç å®ç° `defer` çš„ä¸¤ä¸ªæœ€é‡è¦ç»“æ„ï¼Œä¸€æ—¦å†³å®šä½¿ç”¨å¼€æ”¾ç¼–ç ï¼Œ[`cmd/compile/internal/gc.buildssa`](https://draveness.me/golang/tree/cmd/compile/internal/gc.buildssa) ä¼šåœ¨ç¼–è¯‘æœŸé—´åœ¨æ ˆä¸Šåˆå§‹åŒ–å¤§å°ä¸º 8 ä¸ªæ¯”ç‰¹çš„ `deferBits` å˜é‡ï¼š

```go
func buildssa(fn *Node, worker int) *ssa.Func {
	...
	if s.hasOpenDefers {
		deferBitsTemp := tempAt(src.NoXPos, s.curfn, types.Types[TUINT8]) // åˆå§‹åŒ–å»¶è¿Ÿæ¯”ç‰¹
		s.deferBitsTemp = deferBitsTemp
		startDeferBits := s.entryNewValue0(ssa.OpConst8, types.Types[TUINT8])
		s.vars[&deferBitsVar] = startDeferBits
		s.deferBitsAddr = s.addr(deferBitsTemp)
		s.store(types.Types[TUINT8], s.deferBitsAddr, startDeferBits)
		s.vars[&memVar] = s.newValue1Apos(ssa.OpVarLive, types.TypeMem, deferBitsTemp, s.mem(), false)
	}
}
```

å»¶è¿Ÿæ¯”ç‰¹ä¸­çš„æ¯ä¸€ä¸ªæ¯”ç‰¹ä½éƒ½è¡¨ç¤ºè¯¥ä½å¯¹åº”çš„ `defer` å…³é”®å­—æ˜¯å¦éœ€è¦è¢«æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­ 8 ä¸ªæ¯”ç‰¹çš„å€’æ•°ç¬¬äºŒä¸ªæ¯”ç‰¹åœ¨å‡½æ•°è¿”å›å‰è¢«è®¾ç½®æˆäº† 1ï¼Œé‚£ä¹ˆè¯¥æ¯”ç‰¹ä½å¯¹åº”çš„å‡½æ•°ä¼šåœ¨å‡½æ•°è¿”å›å‰æ‰§è¡Œï¼š

![[Study_dPaul/Golang/Go åŸºç¤æ•™å­¸/_annex/Pasted image 20211103163632.png]]

**å›¾ 3 å»¶è¿Ÿæ¯”ç‰¹**

å› ä¸ºä¸æ˜¯å‡½æ•°ä¸­æ‰€æœ‰çš„ `defer` è¯­å¥éƒ½ä¼šåœ¨å‡½æ•°è¿”å›å‰æ‰§è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„ä»£ç åªä¼šåœ¨ `if` è¯­å¥çš„æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œå…¶ä¸­çš„ `defer` è¯­å¥æ‰ä¼šåœ¨ç»“å°¾è¢«æ‰§è¡Œ[4](https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/#fn:4)ï¼š

```go
deferBits := 0 // åˆå§‹åŒ– deferBits

_f1, _a1 := f1, a1  // ä¿å­˜å‡½æ•°ä»¥åŠå‚æ•°
deferBits |= 1 << 0 // å°† deferBits æœ€åä¸€ä½ç½®ä½ 1

if condition {
    _f2, _a2 := f2, a2  // ä¿å­˜å‡½æ•°ä»¥åŠå‚æ•°
    deferBits |= 1 << 1 // å°† deferBits å€’æ•°ç¬¬äºŒä½ç½®ä½ 1
}
exit:

if deferBits & 1 << 1 != 0 {
    deferBits &^= 1 << 1
    _f2(a2)
}

if deferBits & 1 << 0 != 0 {
    deferBits &^= 1 << 0
    _f1(a1)
}
```

å»¶è¿Ÿæ¯”ç‰¹çš„ä½œç”¨å°±æ˜¯æ ‡è®°å“ªäº› `defer` å…³é”®å­—åœ¨å‡½æ•°ä¸­è¢«æ‰§è¡Œï¼Œè¿™æ ·åœ¨å‡½æ•°è¿”å›æ—¶å¯ä»¥æ ¹æ®å¯¹åº” `deferBits` çš„å†…å®¹ç¡®å®šæ‰§è¡Œçš„å‡½æ•°ï¼Œè€Œæ­£æ˜¯å› ä¸º `deferBits` çš„å¤§å°ä»…ä¸º 8 æ¯”ç‰¹ï¼Œæ‰€ä»¥è¯¥ä¼˜åŒ–çš„å¯ç”¨æ¡ä»¶ä¸ºå‡½æ•°ä¸­çš„ `defer` å…³é”®å­—å°‘äº 8 ä¸ªã€‚

ä¸Šè¿°ä¼ªä»£ç å±•ç¤ºäº†å¼€æ”¾ç¼–ç çš„å®ç°åŸç†ï¼Œä½†æ˜¯ä»ç„¶ç¼ºå°‘äº†ä¸€äº›ç»†èŠ‚ï¼Œä¾‹å¦‚ï¼šä¼ å…¥ `defer` å…³é”®å­—çš„å‡½æ•°å’Œå‚æ•°éƒ½ä¼šå­˜å‚¨åœ¨å¦‚ä¸‹æ‰€ç¤ºçš„ [`cmd/compile/internal/gc.openDeferInfo`](https://draveness.me/golang/tree/cmd/compile/internal/gc.openDeferInfo) ç»“æ„ä½“ä¸­ï¼š

```go
type openDeferInfo struct {
	n           *Node
	closure     *ssa.Value
	closureNode *Node
	rcvr        *ssa.Value
	rcvrNode    *Node
	argVals     []*ssa.Value
	argNodes    []*Node
}
```

å½“ç¼–è¯‘å™¨åœ¨è°ƒç”¨ [`cmd/compile/internal/gc.buildssa`](https://draveness.me/golang/tree/cmd/compile/internal/gc.buildssa) æ„å»ºä¸­é—´ä»£ç æ—¶ä¼šé€šè¿‡ [`cmd/compile/internal/gc.state.openDeferRecord`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.openDeferRecord) æ–¹æ³•åœ¨æ ˆä¸Šæ„å»ºç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“çš„ `closure` ä¸­å­˜å‚¨ç€è°ƒç”¨çš„å‡½æ•°ï¼Œ`rcvr` ä¸­å­˜å‚¨ç€æ–¹æ³•çš„æ¥æ”¶è€…ï¼Œè€Œæœ€åçš„ `argVals` ä¸­å­˜å‚¨äº†å‡½æ•°çš„å‚æ•°ã€‚

å¾ˆå¤š `defer` è¯­å¥éƒ½å¯ä»¥åœ¨ç¼–è¯‘æœŸé—´åˆ¤æ–­æ˜¯å¦è¢«æ‰§è¡Œï¼Œå¦‚æœå‡½æ•°ä¸­çš„ `defer` è¯­å¥éƒ½ä¼šåœ¨ç¼–è¯‘æœŸé—´ç¡®å®šï¼Œä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µå°±ä¼šç›´æ¥è°ƒç”¨ [`cmd/compile/internal/gc.state.openDeferExit`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.openDeferExit) åœ¨å‡½æ•°è¿”å›å‰ç”Ÿæˆåˆ¤æ–­ `deferBits` çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°ä¼ªä»£ç ä¸­çš„ååŠéƒ¨åˆ†ã€‚

ä¸è¿‡å½“ç¨‹åºé‡åˆ°è¿è¡Œæ—¶æ‰èƒ½åˆ¤æ–­çš„æ¡ä»¶è¯­å¥æ—¶ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦ç”±è¿è¡Œæ—¶çš„ [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) å†³å®šæ˜¯å¦æ‰§è¡Œ `defer` å…³é”®å­—ï¼š

```go
func deferreturn(arg0 uintptr) {
	gp := getg()
	d := gp._defer
	sp := getcallersp()
	if d.openDefer {
		runOpenDeferFrame(gp, d)
		gp._defer = d.link
		freedefer(d)
		return
	}
	...
}
```

è¯¥å‡½æ•°ä¸ºå¼€æ”¾ç¼–ç åšäº†ç‰¹æ®Šçš„ä¼˜åŒ–ï¼Œè¿è¡Œæ—¶ä¼šè°ƒç”¨ [`runtime.runOpenDeferFrame`](https://draveness.me/golang/tree/runtime.runOpenDeferFrame) æ‰§è¡Œæ´»è·ƒçš„å¼€æ”¾ç¼–ç å»¶è¿Ÿå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæ‰§è¡Œä»¥ä¸‹çš„å·¥ä½œï¼š

1.  ä» [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“ä¸­è¯»å– `deferBits`ã€å‡½æ•° `defer` æ•°é‡ç­‰ä¿¡æ¯ï¼›
2.  åœ¨å¾ªç¯ä¸­ä¾æ¬¡è¯»å–å‡½æ•°çš„åœ°å€å’Œå‚æ•°ä¿¡æ¯å¹¶é€šè¿‡ `deferBits` åˆ¤æ–­è¯¥å‡½æ•°æ˜¯å¦éœ€è¦è¢«æ‰§è¡Œï¼›
3.  è°ƒç”¨ [`runtime.reflectcallSave`](https://draveness.me/golang/tree/runtime.reflectcallSave) è°ƒç”¨éœ€è¦æ‰§è¡Œçš„ `defer` å‡½æ•°ï¼›

```go
func runOpenDeferFrame(gp *g, d *_defer) bool {
	fd := d.fd

	...
	deferBitsOffset, fd := readvarintUnsafe(fd)
	nDefers, fd := readvarintUnsafe(fd)
	deferBits := *(*uint8)(unsafe.Pointer(d.varp - uintptr(deferBitsOffset)))

	for i := int(nDefers) - 1; i >= 0; i-- {
		var argWidth, closureOffset, nArgs uint32 // è¯»å–å‡½æ•°çš„åœ°å€å’Œå‚æ•°ä¿¡æ¯
		argWidth, fd = readvarintUnsafe(fd)
		closureOffset, fd = readvarintUnsafe(fd)
		nArgs, fd = readvarintUnsafe(fd)
		if deferBits&(1<<i) == 0 {
			...
			continue
		}
		closure := *(**funcval)(unsafe.Pointer(d.varp - uintptr(closureOffset)))
		d.fn = closure

		...

		deferBits = deferBits &^ (1 << i)
		*(*uint8)(unsafe.Pointer(d.varp - uintptr(deferBitsOffset))) = deferBits
		p := d._panic
		reflectcallSave(p, unsafe.Pointer(closure), deferArgs, argWidth)
		if p != nil && p.aborted {
			break
		}
		d.fn = nil
		memclrNoHeapPointers(deferArgs, uintptr(argWidth))
		...
	}
	return done
}
```

Go è¯­è¨€çš„ç¼–è¯‘å™¨ä¸ºäº†æ”¯æŒå¼€æ”¾ç¼–ç åœ¨ä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µåšå‡ºäº†å¾ˆå¤šä¿®æ”¹ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè™½ç„¶çœç•¥äº†å¾ˆå¤šç»†èŠ‚ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°å±•ç¤º `defer` å…³é”®å­—çš„å®ç°åŸç†ã€‚

## å°ç»“

`defer` å…³é”®å­—çš„å®ç°ä¸»è¦ä¾é ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶çš„åä½œï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹æœ¬èŠ‚æåˆ°çš„ä¸‰ç§æœºåˆ¶ï¼š

-   å †ä¸Šåˆ†é… 
    -   ç¼–è¯‘æœŸå°† `defer` å…³é”®å­—è½¬æ¢æˆ [`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc) å¹¶åœ¨è°ƒç”¨ `defer` å…³é”®å­—çš„å‡½æ•°è¿”å›ä¹‹å‰æ’å…¥ [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn)ï¼›
    -   è¿è¡Œæ—¶è°ƒç”¨ [`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc) ä¼šå°†ä¸€ä¸ªæ–°çš„ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„ä½“è¿½åŠ åˆ°å½“å‰ Goroutine çš„é“¾è¡¨å¤´ï¼›
    -   è¿è¡Œæ—¶è°ƒç”¨ [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) ä¼šä» Goroutine çš„é“¾è¡¨ä¸­å–å‡º [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) ç»“æ„å¹¶ä¾æ¬¡æ‰§è¡Œï¼›
-   æ ˆä¸Šåˆ†é…
    -   å½“è¯¥å…³é”®å­—åœ¨å‡½æ•°ä½“ä¸­æœ€å¤šæ‰§è¡Œä¸€æ¬¡æ—¶ï¼Œç¼–è¯‘æœŸé—´çš„ [`cmd/compile/internal/gc.state.call`](https://draveness.me/golang/tree/cmd/compile/internal/gc.state.call) ä¼šå°†ç»“æ„ä½“åˆ†é…åˆ°æ ˆä¸Šå¹¶è°ƒç”¨ [`runtime.deferprocStack`](https://draveness.me/golang/tree/runtime.deferprocStack)ï¼›
-   å¼€æ”¾ç¼–ç  
    -   ç¼–è¯‘æœŸé—´åˆ¤æ–­ `defer` å…³é”®å­—ã€`return` è¯­å¥çš„ä¸ªæ•°ç¡®å®šæ˜¯å¦å¼€å¯å¼€æ”¾ç¼–ç ä¼˜åŒ–ï¼›
    -   é€šè¿‡ `deferBits` å’Œ [`cmd/compile/internal/gc.openDeferInfo`](https://draveness.me/golang/tree/cmd/compile/internal/gc.openDeferInfo) å­˜å‚¨ `defer` å…³é”®å­—çš„ç›¸å…³ä¿¡æ¯ï¼›
    -   å¦‚æœ `defer` å…³é”®å­—çš„æ‰§è¡Œå¯ä»¥åœ¨ç¼–è¯‘æœŸé—´ç¡®å®šï¼Œä¼šåœ¨å‡½æ•°è¿”å›å‰ç›´æ¥æ’å…¥ç›¸åº”çš„ä»£ç ï¼Œå¦åˆ™ä¼šç”±è¿è¡Œæ—¶çš„ [`runtime.deferreturn`](https://draveness.me/golang/tree/runtime.deferreturn) å¤„ç†ï¼›

æˆ‘ä»¬åœ¨æœ¬èŠ‚å‰é¢æåˆ°çš„ä¸¤ä¸ªç°è±¡åœ¨è¿™é‡Œä¹Ÿå¯ä»¥è§£é‡Šæ¸…æ¥šäº†ï¼š

-   åè°ƒç”¨çš„ `defer` å‡½æ•°ä¼šå…ˆæ‰§è¡Œï¼š
    -   åè°ƒç”¨çš„ `defer` å‡½æ•°ä¼šè¢«è¿½åŠ åˆ° Goroutine `_defer` é“¾è¡¨çš„æœ€å‰é¢ï¼›
    -   è¿è¡Œ [`runtime._defer`](https://draveness.me/golang/tree/runtime._defer) æ—¶æ˜¯ä»å‰åˆ°åä¾æ¬¡æ‰§è¡Œï¼›
-   å‡½æ•°çš„å‚æ•°ä¼šè¢«é¢„å…ˆè®¡ç®—ï¼›
    -   è°ƒç”¨ [`runtime.deferproc`](https://draveness.me/golang/tree/runtime.deferproc) å‡½æ•°åˆ›å»ºæ–°çš„å»¶è¿Ÿè°ƒç”¨æ—¶å°±ä¼šç«‹åˆ»æ‹·è´å‡½æ•°çš„å‚æ•°ï¼Œå‡½æ•°çš„å‚æ•°ä¸ä¼šç­‰åˆ°çœŸæ­£æ‰§è¡Œæ—¶è®¡ç®—ï¼›