---
Date: 2021-10-26
aliases: []
---

# Metadata

**Title** :: æœåŠ¡å™¨ç»Ÿä¸€é”™è¯¯å¤„ç†

**Author** :: #dPaulLai

**Classification** :: #Learn #Go #Basic

**Status** :: #ğŸŒ 

**Type** :: #Note

**Previous** ::

**ParentNode** :: [[Go åŸºç¤æ•™å­¸]]

---

# æœåŠ¡å™¨ç»Ÿä¸€é”™è¯¯å¤„ç†


1. å…ˆæ„å»ºä¸€ä¸ª Http æœåŠ¡å™¨,åŒæ—¶å…·å¤‡ä¸€ä¸ª`/A`çš„API

	```go
	package main  

	import (  
	 "fmt"  
	 "net/http"
	)  

	func main() {  
		http.HandleFunc("/A", func(writer http.ResponseWriter, request *http.Request) {  
			fmt.Println("A") 
			_, _ = writer.Write([]byte("è¯·æ±‚æˆåŠŸ\n"))
		})
		// URL ä¸º http://127.0.0.1:8080
		err := http.ListenAndServe(":8080", nil)  
		if err != nil {  
			panic(err)  
		}
	}
	```
	è®¿é—®è¯¥APIæ—¶,ä¼šä½¿æœåŠ¡å™¨å†…éƒ¨æ‰“å°ä¸€å¥`A`

2. å¼ºåˆ¶è®©æœåŠ¡å™¨å†…éƒ¨å‘ç”Ÿé”™è¯¯
	```go
	package main  

	import (  
	 "errors"  
	 "net/http")  

	func main() {  
		http.HandleFunc("/A", func(writer http.ResponseWriter, request *http.Request) {  
			err := errors.New("æ•…æ„äº§ç”Ÿå¼‚å¸¸")  
			panic(err)
			_, _ = writer.Write([]byte("è¯·æ±‚æˆåŠŸ\n"))
		})
		err := http.ListenAndServe(":8080", nil)  
		if err != nil {  
			panic(err)  
		}
	}
	```

	æ­¤æ—¶,å‘ç”Ÿå¼‚å¸¸æ—¶æ§åˆ¶å°å°†æ‰“å°ä¸€ä¸‹å†…å®¹
	```bash
	2021/10/26 09:41:27 http: panic serving 127.0.0.1:61250: æ•…æ„äº§ç”Ÿå¼‚å¸¸
	goroutine 6 [running]:
	... ...
	... ...
	... ...
	created by net/http.(*Server).Serve
		C:/Program Files/Go/src/net/http/server.go:3033 +0x4e8

	```

	è€Œå‰ç«¯ä¹Ÿå°†è¿”å› `org.apache.http.NoHttpResponseException: 127.0.0.1:8080 failed to respond`

3. åŸºç¡€å¤„ç†æŠ¥é”™æ–¹å¼
	```go
	package main  

	import (  
	 "errors"  
	 "fmt" "net/http")  

	func main() {  
		http.HandleFunc("/A", func(writer http.ResponseWriter, request *http.Request) {  
			err := errors.New("æ•…æ„äº§ç”Ÿå¼‚å¸¸")  
			if err != nil {  
				fmt.Println(err.Error())  
				_, _ = writer.Write([]byte(err.Error()))  
			} else {  
				_, _ = writer.Write([]byte("è¯·æ±‚æˆåŠŸ\n"))  
			} 
		}) 
		err := http.ListenAndServe(":8080", nil)  
		if err != nil {  
			panic(err)  
		}
	}
	```

	å°†æ¯æ¬¡äº§ç”Ÿå‡ºæ¥çš„å¼‚å¸¸éƒ½è¿›è¡Œæ•è·,ç„¶ååšå¼‚å¸¸å¤„ç†

	è¿™ä¸ªæ–¹æ³•æ˜¯å¯ä»¥è§£å†³å¼‚å¸¸é—®é¢˜,ä½†æ˜¯ä¼šæ˜¾å¾—éå¸¸çš„éº»çƒ¦,ä¸”ä»£ç ä¼šéå¸¸å†—ä½™

4. ç»Ÿä¸€å¤„ç†æŠ¥é”™æ–¹å¼
	```go
	
	package main  

	import (  
	 "fmt"  
	 "net/http" "os")  

	func main() {  
		http.HandleFunc("/A", errWrapper(handleA))  
		err := http.ListenAndServe(":8080", nil)  
		if err != nil {  
			panic(err)  
		}
	}  

	func handleA(writer http.ResponseWriter, request *http.Request) error {  
		_, _ = writer.Write([]byte("è¯·æ±‚æˆåŠŸ\n"))  
		return userErrorImpl("æ•…æ„äº§ç”Ÿå¼‚å¸¸")  
	}  

	// appHandler  
	type appHandler func(writer http.ResponseWriter, request *http.Request) error  

	// errWrapper å¼‚å¸¸å¤„ç†å™¨  
	func errWrapper(handler appHandler) func(writer http.ResponseWriter, request *http.Request) {  
		return func(writer http.ResponseWriter, request *http.Request) {  
			err := handler(writer, request)  
			if err != nil {  
				// user error  
				if userErr, ok := err.(userError); ok {  
					fmt.Println(userErr.Message())  
					_, _ = writer.Write([]byte(userErr.Message()))  
					return  
				}  

				// system error  
				code := http.StatusOK  
				switch {  
				case os.IsNotExist(err):  
						code = http.StatusNotFound  
				case os.IsPermission(err):  
						code = http.StatusForbidden  
				default:  
						code = http.StatusInternalServerError  
				} 
				http.Error(writer, http.StatusText(code), code)  
			} 
		}
	}  

	// userError å®šä¹‰ä¸€ä¸ªæ¥å£  
	type userError interface {  
		error  
		Message() string  
	}  

	// userErrorImpl åŸºäº string åˆ¶ä½œäº†ä¸€ä¸ªç”¨æˆ·é”™è¯¯  
	type userErrorImpl string  

	// Error ç»§æ‰¿ userError
	func (e userErrorImpl) Error() string {  
		return e.Message()  
	}  

	// Message ç»§æ‰¿ userError
	func (e userErrorImpl) Message() string {  
		return string(e)  
	}
	```

	æ‰€æœ‰çš„é”™è¯¯å°è£…éƒ½å¯ä»¥åœ¨`errWrapper`ä¸­è¿›è¡Œå¤„ç†		
5. ç»Ÿä¸€å¤„ç†æŠ¥é”™(ä½¿ç”¨[[Study_dPaul/Golang/Go åŸºç¤æ•™å­¸/1-8-4#Recover|Recover]])
	```go
	// errWrapper å¼‚å¸¸å¤„ç†å™¨  
	func errWrapper(handler appHandler) func(writer http.ResponseWriter, request *http.Request) {  
		return func(writer http.ResponseWriter, request *http.Request) {  
			// panic  
			defer func() {  
				if r := recover(); r != nil {  
					log.Printf("Panic: %v", r)  
					http.Error(writer, http.StatusText(http.StatusInternalServerError), http.StatusInternalServerError)  
			    }
			}()
			
			err := handler(writer, request)  
			if err != nil {  
				// user error  
				if userErr, ok := err.(userError); ok {  
					fmt.Println(userErr.Message())  
					_, _ = writer.Write([]byte(userErr.Message()))  
					return  
				}  

				// system error  
				code := http.StatusOK  
				switch {  
				case os.IsNotExist(err):  
						code = http.StatusNotFound  
				case os.IsPermission(err):  
						code = http.StatusForbidden  
				default:  
						code = http.StatusInternalServerError  
				} 
				http.Error(writer, http.StatusText(code), code)  
			} 
		}
	}  
	```
	
	æ·»åŠ Recoverå¯¹æœªæ•è·çš„å¼‚å¸¸è¿›è¡Œæœ€ç»ˆå¤„ç†